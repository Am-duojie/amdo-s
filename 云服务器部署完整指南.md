# äº‘æœåŠ¡å™¨éƒ¨ç½²å®Œæ•´æŒ‡å—

## ğŸ“‹ ç›®å½•
1. [å‡†å¤‡å·¥ä½œ](#å‡†å¤‡å·¥ä½œ)
2. [æœåŠ¡å™¨ç¯å¢ƒé…ç½®](#æœåŠ¡å™¨ç¯å¢ƒé…ç½®)
3. [æ•°æ®åº“å’ŒRedisé…ç½®](#æ•°æ®åº“å’Œredisé…ç½®)
4. [é¡¹ç›®ä»£ç éƒ¨ç½²](#é¡¹ç›®ä»£ç éƒ¨ç½²)
5. [åç«¯æœåŠ¡é…ç½®](#åç«¯æœåŠ¡é…ç½®)
6. [å‰ç«¯æ„å»ºå’Œéƒ¨ç½²](#å‰ç«¯æ„å»ºå’Œéƒ¨ç½²)
7. [Nginxåå‘ä»£ç†é…ç½®](#nginxåå‘ä»£ç†é…ç½®)
8. [SSLè¯ä¹¦é…ç½®](#sslè¯ä¹¦é…ç½®)
9. [åŸŸåé…ç½®](#åŸŸåé…ç½®)
10. [æœåŠ¡ç®¡ç†å’Œç›‘æ§](#æœåŠ¡ç®¡ç†å’Œç›‘æ§)
11. [å¤‡ä»½å’Œå®‰å…¨](#å¤‡ä»½å’Œå®‰å…¨)
12. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ğŸ¯ å‡†å¤‡å·¥ä½œ

### 1. äº‘æœåŠ¡å™¨é€‰æ‹©

#### æ¨èäº‘æœåŠ¡å•†

| æœåŠ¡å•† | ä¼˜åŠ¿ | é€‚åˆåœºæ™¯ |
|--------|------|---------|
| **é˜¿é‡Œäº‘** | å›½å†…é€Ÿåº¦å¿«ï¼Œæ–‡æ¡£å®Œå–„ | å›½å†…ç”¨æˆ·ï¼Œä¼ä¸šçº§åº”ç”¨ |
| **è…¾è®¯äº‘** | ä»·æ ¼ä¼˜æƒ ï¼Œæ–°æ‰‹å‹å¥½ | ä¸ªäººå¼€å‘è€…ï¼Œå°å‹é¡¹ç›® |
| **åä¸ºäº‘** | ç¨³å®šæ€§å¥½ | ä¼ä¸šåº”ç”¨ |
| **Vultr** | å›½å¤–é€Ÿåº¦å¿«ï¼ŒæŒ‰å°æ—¶è®¡è´¹ | å›½å¤–è®¿é—®ï¼Œæµ‹è¯•ä½¿ç”¨ |

#### æœåŠ¡å™¨é…ç½®æ¨è

| ç”¨é€” | CPU | å†…å­˜ | ç¡¬ç›˜ | å¸¦å®½ | ä»·æ ¼å‚è€ƒ |
|------|-----|------|------|------|---------|
| **æµ‹è¯•/å­¦ä¹ ** | 1æ ¸ | 2GB | 40GB | 1Mbps | Â¥50-100/æœˆ |
| **å°å‹é¡¹ç›®** | 2æ ¸ | 4GB | 80GB | 3Mbps | Â¥200-300/æœˆ |
| **ä¸­å‹é¡¹ç›®** | 4æ ¸ | 8GB | 200GB | 5Mbps | Â¥500-800/æœˆ |

**ä¸ªäººå¼€å‘æ¨èï¼š2æ ¸4GB é…ç½®**

### 2. æ“ä½œç³»ç»Ÿé€‰æ‹©

æ¨èä½¿ç”¨ **Ubuntu 22.04 LTS** æˆ– **CentOS 8**ï¼ˆå·²åœæ­¢ç»´æŠ¤ï¼Œå»ºè®®ç”¨ Ubuntuï¼‰

- âœ… Ubuntu 22.04 LTS - æ¨èï¼ˆè½¯ä»¶åŒ…æ–°ï¼Œç¤¾åŒºæ´»è·ƒï¼‰
- âœ… CentOS Stream - å¯é€‰
- âŒ CentOS 7 - ä¸æ¨èï¼ˆå·²åœæ­¢ç»´æŠ¤ï¼‰

### 3. æœåŠ¡å™¨è´­ä¹°æ­¥éª¤

ä»¥ **é˜¿é‡Œäº‘** ä¸ºä¾‹ï¼š

1. **æ³¨å†Œè´¦å·**ï¼šè®¿é—® https://www.aliyun.com/
2. **å®åè®¤è¯**ï¼šå®Œæˆå®åè®¤è¯
3. **è´­ä¹°æœåŠ¡å™¨**ï¼š
   - è¿›å…¥ ECS äº‘æœåŠ¡å™¨æ§åˆ¶å°
   - ç‚¹å‡»"åˆ›å»ºå®ä¾‹"
   - é€‰æ‹©é…ç½®ï¼š2æ ¸4GBï¼ŒUbuntu 22.04
   - è®¾ç½®å¯†ç æˆ–SSHå¯†é’¥
   - é€‰æ‹©å¸¦å®½ï¼š1-3Mbps
4. **é…ç½®å®‰å…¨ç»„**ï¼š
   - å¼€æ”¾ç«¯å£ï¼š22ï¼ˆSSHï¼‰ã€80ï¼ˆHTTPï¼‰ã€443ï¼ˆHTTPSï¼‰ã€8000ï¼ˆåç«¯ï¼Œå¯é€‰ï¼‰
5. **è·å–æœåŠ¡å™¨ä¿¡æ¯**ï¼š
   - å…¬ç½‘IPï¼šä¾‹å¦‚ `123.456.789.0`
   - ç™»å½•å¯†ç æˆ–SSHå¯†é’¥

### 4. åŸŸåå‡†å¤‡ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦ä½¿ç”¨åŸŸåï¼š
- **è´­ä¹°åŸŸå**ï¼šé˜¿é‡Œäº‘ã€è…¾è®¯äº‘ã€Godaddy
- **å¤‡æ¡ˆ**ï¼šå›½å†…æœåŠ¡å™¨éœ€è¦å¤‡æ¡ˆï¼ˆé€šå¸¸7-15å¤©ï¼‰
- **è§£æé…ç½®**ï¼šå°†åŸŸåè§£æåˆ°æœåŠ¡å™¨IP

---

## ğŸ”§ æœåŠ¡å™¨ç¯å¢ƒé…ç½®

### 1. è¿æ¥æœåŠ¡å™¨

#### Windows ä½¿ç”¨ SSH è¿æ¥

**æ–¹å¼1ï¼šä½¿ç”¨ PowerShell**
```powershell
ssh root@ä½ çš„æœåŠ¡å™¨IP
# è¾“å…¥å¯†ç 
```

**æ–¹å¼2ï¼šä½¿ç”¨ PuTTY**
- ä¸‹è½½ PuTTYï¼šhttps://www.putty.org/
- Host: æœåŠ¡å™¨IP
- Port: 22
- è¿æ¥ç±»å‹ï¼šSSH

**æ–¹å¼3ï¼šä½¿ç”¨ VSCode Remote SSH**
- å®‰è£… Remote SSH æ‰©å±•
- è¿æ¥æœåŠ¡å™¨è¿›è¡Œè¿œç¨‹å¼€å‘

#### é¦–æ¬¡ç™»å½•åæ“ä½œ

```bash
# æ›´æ–°ç³»ç»ŸåŒ…
sudo apt update
sudo apt upgrade -y

# åˆ›å»ºérootç”¨æˆ·ï¼ˆå¯é€‰ï¼Œæ¨èï¼‰
sudo adduser your_username
sudo usermod -aG sudo your_username

# åˆ‡æ¢åˆ°æ–°ç”¨æˆ·
su - your_username
```

### 2. å®‰è£…åŸºç¡€è½¯ä»¶

```bash
# å®‰è£…åŸºç¡€å·¥å…·
sudo apt install -y curl wget git vim

# å®‰è£…é˜²ç«å¢™å·¥å…·
sudo apt install -y ufw

# é…ç½®é˜²ç«å¢™
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw enable
```

### 3. å®‰è£… Python 3.10+

```bash
# Ubuntu 22.04 è‡ªå¸¦ Python 3.10
python3 --version

# å¦‚æœæ²¡æœ‰ï¼Œå®‰è£… Python 3.10
sudo apt install -y python3.10 python3.10-venv python3.10-dev python3-pip

# å®‰è£… pip å‡çº§å·¥å…·
python3 -m pip install --upgrade pip
```

### 4. å®‰è£… Node.js 18+

```bash
# ä½¿ç”¨ NodeSource å®‰è£… Node.js 18
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# éªŒè¯å®‰è£…
node --version
npm --version

# å®‰è£… yarnï¼ˆå¯é€‰ï¼‰
npm install -g yarn
```

### 5. å®‰è£… MySQL 8.0

```bash
# å®‰è£… MySQL
sudo apt install -y mysql-server

# å¯åŠ¨ MySQL æœåŠ¡
sudo systemctl start mysql
sudo systemctl enable mysql

# å®‰å…¨é…ç½®
sudo mysql_secure_installation

# ç™»å½• MySQL åˆ›å»ºæ•°æ®åº“
sudo mysql -u root -p

# åœ¨ MySQL ä¸­æ‰§è¡Œ
CREATE DATABASE secondhand_platform CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'dbuser'@'localhost' IDENTIFIED BY 'ä½ çš„æ•°æ®åº“å¯†ç ';
GRANT ALL PRIVILEGES ON secondhand_platform.* TO 'dbuser'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

### 6. å®‰è£… Redis

```bash
# å®‰è£… Redis
sudo apt install -y redis-server

# å¯åŠ¨ Redis
sudo systemctl start redis-server
sudo systemctl enable redis-server

# æµ‹è¯• Redis
redis-cli ping
# åº”è¯¥è¿”å› PONG

# é…ç½® Redisï¼ˆå¯é€‰ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®é…ç½®å¯†ç ï¼‰
sudo vim /etc/redis/redis.conf
# æ‰¾åˆ° # requirepass foobaredï¼Œå–æ¶ˆæ³¨é‡Šå¹¶è®¾ç½®å¯†ç 
# requirepass ä½ çš„rediså¯†ç 
```

### 7. å®‰è£… Nginx

```bash
# å®‰è£… Nginx
sudo apt install -y nginx

# å¯åŠ¨ Nginx
sudo systemctl start nginx
sudo systemctl enable nginx

# æµ‹è¯• Nginx
curl http://localhost
# åº”è¯¥è¿”å› Nginx æ¬¢è¿é¡µé¢
```

---

## ğŸ’¾ æ•°æ®åº“å’ŒRedisé…ç½®

### 1. MySQL é…ç½®ä¼˜åŒ–

ç¼–è¾‘ MySQL é…ç½®æ–‡ä»¶ï¼š
```bash
sudo vim /etc/mysql/mysql.conf.d/mysqld.cnf
```

æ·»åŠ æˆ–ä¿®æ”¹ï¼š
```ini
[mysqld]
# å­—ç¬¦é›†é…ç½®
character-set-server=utf8mb4
collation-server=utf8mb4_unicode_ci

# æ€§èƒ½ä¼˜åŒ–
max_connections = 200
innodb_buffer_pool_size = 1G
```

é‡å¯ MySQLï¼š
```bash
sudo systemctl restart mysql
```

### 2. Redis é…ç½®ä¼˜åŒ–

ç¼–è¾‘ Redis é…ç½®æ–‡ä»¶ï¼š
```bash
sudo vim /etc/redis/redis.conf
```

ä¿®æ”¹ï¼š
```conf
# ç»‘å®šåœ°å€ï¼ˆä»…æœ¬åœ°ï¼‰
bind 127.0.0.1

# è®¾ç½®å¯†ç ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ï¼‰
requirepass ä½ çš„rediså¯†ç 

# æŒä¹…åŒ–é…ç½®
save 900 1
save 300 10
save 60 10000
```

é‡å¯ Redisï¼š
```bash
sudo systemctl restart redis-server
```

---

## ğŸ“¦ é¡¹ç›®ä»£ç éƒ¨ç½²

### 1. åˆ›å»ºé¡¹ç›®ç›®å½•

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
sudo mkdir -p /var/www/secondhand
sudo chown -R $USER:$USER /var/www/secondhand
cd /var/www/secondhand
```

### 2. ä¸Šä¼ é¡¹ç›®ä»£ç 

#### æ–¹å¼1ï¼šä½¿ç”¨ Gitï¼ˆæ¨èï¼‰

```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/ä½ çš„ç”¨æˆ·å/ä½ çš„ä»“åº“å.git .

# æˆ–ä½¿ç”¨ SSH
git clone git@github.com:ä½ çš„ç”¨æˆ·å/ä½ çš„ä»“åº“å.git .
```

#### æ–¹å¼2ï¼šä½¿ç”¨ SCP ä¸Šä¼ 

åœ¨æœ¬åœ° Windows æ‰§è¡Œï¼š
```powershell
# ä¸Šä¼ æ•´ä¸ªé¡¹ç›®ç›®å½•
scp -r D:\AAA\æ¯•ä¸šè®¾è®¡ root@ä½ çš„æœåŠ¡å™¨IP:/var/www/secondhand/
```

#### æ–¹å¼3ï¼šä½¿ç”¨ VSCode Remote SSH

- ä½¿ç”¨ Remote SSH è¿æ¥æœåŠ¡å™¨
- ç›´æ¥æ‹–æ‹½æ–‡ä»¶æˆ–ä½¿ç”¨æ–‡ä»¶ç®¡ç†å™¨

### 3. é…ç½® Python è™šæ‹Ÿç¯å¢ƒ

```bash
cd /var/www/secondhand/backend

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3 -m venv venv

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source venv/bin/activate

# å‡çº§ pip
pip install --upgrade pip

# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# å¦‚æœé‡åˆ°ç¼–è¯‘é”™è¯¯ï¼Œå®‰è£…ç¼–è¯‘å·¥å…·
sudo apt install -y build-essential libssl-dev libffi-dev python3-dev
```

### 4. é…ç½®ç¯å¢ƒå˜é‡

åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶ï¼š
```bash
cd /var/www/secondhand/backend
vim .env
```

æ·»åŠ å†…å®¹ï¼š
```env
# Django é…ç½®
DJANGO_SETTINGS_MODULE=core.settings_production
SECRET_KEY=ä½ çš„å¯†é’¥ï¼ˆä½¿ç”¨python manage.py generate_secret_keyç”Ÿæˆï¼‰

# æ•°æ®åº“é…ç½®
DB_NAME=secondhand_platform
DB_USER=dbuser
DB_PASSWORD=ä½ çš„æ•°æ®åº“å¯†ç 
DB_HOST=127.0.0.1
DB_PORT=3306

# Redis é…ç½®ï¼ˆå¦‚æœè®¾ç½®äº†å¯†ç ï¼‰
REDIS_PASSWORD=ä½ çš„rediså¯†ç 

# æ”¯ä»˜é…ç½®
EASYPAY_PID=ä½ çš„å•†æˆ·ID
EASYPAY_KEY=ä½ çš„å•†æˆ·å¯†é’¥
EASYPAY_NOTIFY_URL=https://ä½ çš„åŸŸå/api/payment/notify/
EASYPAY_RETURN_URL=https://ä½ çš„åŸŸå/order/
```

è®¾ç½®æ–‡ä»¶æƒé™ï¼ˆä¿æŠ¤æ•æ„Ÿä¿¡æ¯ï¼‰ï¼š
```bash
chmod 600 .env
```

### 5. é…ç½®ç”Ÿäº§ç¯å¢ƒè®¾ç½®

ç¼–è¾‘ `backend/core/settings_production.py`ï¼š

```python
from .settings import *
import os
from decouple import config  # éœ€è¦å®‰è£… python-decouple

# å®‰å…¨è®¾ç½®
DEBUG = False
SECRET_KEY = config('SECRET_KEY', default='ä½ çš„å¯†é’¥')

# å…è®¸çš„ä¸»æœº
ALLOWED_HOSTS = [
    'localhost',
    '127.0.0.1',
    'ä½ çš„æœåŠ¡å™¨IP',
    'ä½ çš„åŸŸå.com',  # å¦‚æœæœ‰åŸŸå
    'www.ä½ çš„åŸŸå.com',
]

# æ•°æ®åº“é…ç½®ï¼ˆä»ç¯å¢ƒå˜é‡è¯»å–ï¼‰
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': config('DB_NAME', default='secondhand_platform'),
        'USER': config('DB_USER', default='root'),
        'PASSWORD': config('DB_PASSWORD'),
        'HOST': config('DB_HOST', default='127.0.0.1'),
        'PORT': config('DB_PORT', default='3306'),
        'OPTIONS': {
            'charset': 'utf8mb4',
        },
    }
}

# CORS é…ç½®
CORS_ALLOWED_ORIGINS = [
    "https://ä½ çš„åŸŸå.com",
    "https://www.ä½ çš„åŸŸå.com",
]

# Redis é…ç½®ï¼ˆå¦‚æœè®¾ç½®äº†å¯†ç ï¼‰
REDIS_PASSWORD = config('REDIS_PASSWORD', default='')
CHANNEL_LAYERS = {
    "default": {
        "BACKEND": "channels_redis.core.RedisChannelLayer",
        "CONFIG": {
            "hosts": [("127.0.0.1", 6379)],
            "password": REDIS_PASSWORD if REDIS_PASSWORD else None,
        },
    },
}

# æ”¯ä»˜å›è°ƒåœ°å€
EASYPAY_NOTIFY_URL = config('EASYPAY_NOTIFY_URL', default='')
EASYPAY_RETURN_URL = config('EASYPAY_RETURN_URL', default='')

# æ—¥å¿—é…ç½®
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '{levelname} {asctime} {module} {process:d} {thread:d} {message}',
            'style': '{',
        },
    },
    'handlers': {
        'file': {
            'level': 'INFO',
            'class': 'logging.FileHandler',
            'filename': '/var/www/secondhand/backend/logs/django.log',
            'formatter': 'verbose',
        },
    },
    'loggers': {
        'django': {
            'handlers': ['file'],
            'level': 'INFO',
            'propagate': True,
        },
    },
}

# é™æ€æ–‡ä»¶å’Œåª’ä½“æ–‡ä»¶
STATIC_ROOT = '/var/www/secondhand/backend/static'
MEDIA_ROOT = '/var/www/secondhand/backend/media'
```

### 6. åˆå§‹åŒ–æ•°æ®åº“

```bash
cd /var/www/secondhand/backend
source venv/bin/activate

# è®¾ç½®ç¯å¢ƒå˜é‡
export DJANGO_SETTINGS_MODULE=core.settings_production

# æ‰§è¡Œæ•°æ®åº“è¿ç§»
python manage.py makemigrations
python manage.py migrate

# æ”¶é›†é™æ€æ–‡ä»¶
python manage.py collectstatic --noinput

# åˆ›å»ºè¶…çº§ç”¨æˆ·ï¼ˆå¯é€‰ï¼‰
python manage.py createsuperuser

# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p logs
```

---

## ğŸš€ åç«¯æœåŠ¡é…ç½®

### 1. å®‰è£…ç”Ÿäº§ç¯å¢ƒä¾èµ–

```bash
cd /var/www/secondhand/backend
source venv/bin/activate

# å®‰è£… Gunicornï¼ˆWSGIæœåŠ¡å™¨ï¼Œå¦‚æœä¸éœ€è¦WebSocketï¼‰
pip install gunicorn

# å®‰è£… Daphneï¼ˆASGIæœåŠ¡å™¨ï¼Œæ”¯æŒWebSocketï¼Œæ¨èï¼‰
pip install daphne
```

### 2. åˆ›å»º systemd æœåŠ¡æ–‡ä»¶

åˆ›å»ºåç«¯æœåŠ¡ï¼š
```bash
sudo vim /etc/systemd/system/secondhand-backend.service
```

æ·»åŠ å†…å®¹ï¼š
```ini
[Unit]
Description=Secondhand Platform Django Backend
After=network.target mysql.service redis-server.service

[Service]
Type=simple
User=ä½ çš„ç”¨æˆ·å
Group=www-data
WorkingDirectory=/var/www/secondhand/backend
Environment="PATH=/var/www/secondhand/backend/venv/bin"
Environment="DJANGO_SETTINGS_MODULE=core.settings_production"
ExecStart=/var/www/secondhand/backend/venv/bin/daphne -b 127.0.0.1 -p 8000 core.asgi:application
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

å¦‚æœä¸éœ€è¦ WebSocketï¼Œä½¿ç”¨ Gunicornï¼š
```ini
[Service]
ExecStart=/var/www/secondhand/backend/venv/bin/gunicorn core.wsgi:application --bind 127.0.0.1:8000 --workers 4 --timeout 120
```

### 3. å¯åŠ¨å’Œç®¡ç†æœåŠ¡

```bash
# é‡æ–°åŠ è½½ systemd é…ç½®
sudo systemctl daemon-reload

# å¯åŠ¨æœåŠ¡
sudo systemctl start secondhand-backend

# è®¾ç½®å¼€æœºè‡ªå¯
sudo systemctl enable secondhand-backend

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status secondhand-backend

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u secondhand-backend -f
```

---

## ğŸ¨ å‰ç«¯æ„å»ºå’Œéƒ¨ç½²

### 1. å®‰è£…å‰ç«¯ä¾èµ–

```bash
cd /var/www/secondhand/frontend

# å®‰è£…ä¾èµ–
npm install

# æˆ–ä½¿ç”¨ yarn
yarn install
```

### 2. é…ç½®ç”Ÿäº§ç¯å¢ƒå˜é‡

åˆ›å»º `.env.production`ï¼š
```bash
vim /var/www/secondhand/frontend/.env.production
```

æ·»åŠ ï¼š
```env
VITE_API_URL=https://ä½ çš„åŸŸå/api
# æˆ–ä½¿ç”¨IP
# VITE_API_URL=http://ä½ çš„æœåŠ¡å™¨IP:8000/api
```

### 3. æ„å»ºå‰ç«¯é¡¹ç›®

```bash
cd /var/www/secondhand/frontend

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build

# æ„å»ºå®Œæˆåï¼Œdist ç›®å½•å°±æ˜¯ç”Ÿäº§æ–‡ä»¶
ls -la dist/
```

### 4. è®¾ç½®æ–‡ä»¶æƒé™

```bash
# è®¾ç½®ç›®å½•æ‰€æœ‰è€…
sudo chown -R www-data:www-data /var/www/secondhand/frontend/dist
sudo chown -R www-data:www-data /var/www/secondhand/backend/static
sudo chown -R www-data:www-data /var/www/secondhand/backend/media
```

---

## ğŸŒ Nginxåå‘ä»£ç†é…ç½®

### 1. åˆ›å»º Nginx é…ç½®æ–‡ä»¶

```bash
sudo vim /etc/nginx/sites-available/secondhand
```

æ·»åŠ é…ç½®ï¼š
```nginx
# HTTP æœåŠ¡å™¨ï¼ˆç¨åé…ç½® HTTPSï¼‰
server {
    listen 80;
    server_name ä½ çš„åŸŸå.com www.ä½ çš„åŸŸå.com;  # æˆ–ä½¿ç”¨æœåŠ¡å™¨IP
    
    # å‰ç«¯é™æ€æ–‡ä»¶
    root /var/www/secondhand/frontend/dist;
    index index.html;

    # å‰ç«¯è·¯ç”±ï¼ˆVue Routerï¼‰
    location / {
        try_files $uri $uri/ /index.html;
    }

    # åç«¯ API
    location /api {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket æ”¯æŒ
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # WebSocket è¿æ¥
    location /ws {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # é™æ€æ–‡ä»¶
    location /static {
        alias /var/www/secondhand/backend/static;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # åª’ä½“æ–‡ä»¶ï¼ˆä¸Šä¼ çš„å›¾ç‰‡ç­‰ï¼‰
    location /media {
        alias /var/www/secondhand/backend/media;
        expires 7d;
        add_header Cache-Control "public";
    }

    # æ—¥å¿—
    access_log /var/log/nginx/secondhand_access.log;
    error_log /var/log/nginx/secondhand_error.log;
}
```

### 2. å¯ç”¨é…ç½®

```bash
# åˆ›å»ºç¬¦å·é“¾æ¥
sudo ln -s /etc/nginx/sites-available/secondhand /etc/nginx/sites-enabled/

# åˆ é™¤é»˜è®¤é…ç½®ï¼ˆå¯é€‰ï¼‰
sudo rm /etc/nginx/sites-enabled/default

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡å¯ Nginx
sudo systemctl restart nginx
```

### 3. æµ‹è¯•è®¿é—®

```bash
# æµ‹è¯• HTTP è®¿é—®
curl http://ä½ çš„åŸŸåæˆ–IP

# æŸ¥çœ‹ Nginx æ—¥å¿—
sudo tail -f /var/log/nginx/secondhand_access.log
sudo tail -f /var/log/nginx/secondhand_error.log
```

---

## ğŸ”’ SSLè¯ä¹¦é…ç½®

### 1. å®‰è£… Certbot

```bash
# å®‰è£… Certbot
sudo apt install -y certbot python3-certbot-nginx

# æˆ–ä½¿ç”¨ Snapï¼ˆæ¨èï¼‰
sudo snap install --classic certbot
sudo ln -s /snap/bin/certbot /usr/bin/certbot
```

### 2. è·å– SSL è¯ä¹¦

```bash
# è‡ªåŠ¨é…ç½® Nginx + SSL
sudo certbot --nginx -d ä½ çš„åŸŸå.com -d www.ä½ çš„åŸŸå.com

# æŒ‰ç…§æç¤ºè¾“å…¥é‚®ç®±ç­‰ä¿¡æ¯
# Certbot ä¼šè‡ªåŠ¨ä¿®æ”¹ Nginx é…ç½®å¹¶é‡å¯æœåŠ¡
```

### 3. è‡ªåŠ¨ç»­æœŸ

Certbot ä¼šè‡ªåŠ¨åˆ›å»ºç»­æœŸä»»åŠ¡ï¼Œå¯ä»¥æ‰‹åŠ¨æµ‹è¯•ï¼š
```bash
# æµ‹è¯•ç»­æœŸ
sudo certbot renew --dry-run

# æŸ¥çœ‹ç»­æœŸä»»åŠ¡
sudo systemctl status certbot.timer
```

### 4. æ›´æ–° Nginx é…ç½®ï¼ˆå¦‚æœæœ‰åŸŸåï¼‰

é…ç½®å¥½ SSL åï¼Œæ›´æ–° `settings_production.py`ï¼š

```python
# å…è®¸ HTTPS
SECURE_SSL_REDIRECT = True
SESSION_COOKIE_SECURE = True
CSRF_COOKIE_SECURE = True
```

---

## ğŸŒ åŸŸåé…ç½®

### 1. åŸŸåè§£æ

åœ¨åŸŸåæœåŠ¡å•†æ§åˆ¶å°æ·»åŠ  DNS è®°å½•ï¼š

| ç±»å‹ | ä¸»æœºè®°å½• | è®°å½•å€¼ | TTL |
|------|---------|--------|-----|
| A | @ | ä½ çš„æœåŠ¡å™¨IP | 600 |
| A | www | ä½ çš„æœåŠ¡å™¨IP | 600 |

### 2. ç­‰å¾… DNS ç”Ÿæ•ˆ

```bash
# æ£€æŸ¥ DNS è§£æ
nslookup ä½ çš„åŸŸå.com
ping ä½ çš„åŸŸå.com
```

é€šå¸¸éœ€è¦å‡ åˆ†é’Ÿåˆ°å‡ å°æ—¶ç”Ÿæ•ˆã€‚

### 3. æ›´æ–°é¡¹ç›®é…ç½®

ä¿®æ”¹ `settings_production.py` å’Œå‰ç«¯ `.env.production`ï¼Œä½¿ç”¨åŸŸåè€Œä¸æ˜¯ IPã€‚

---

## ğŸ”§ æœåŠ¡ç®¡ç†å’Œç›‘æ§

### 1. æœåŠ¡ç®¡ç†å‘½ä»¤

```bash
# åç«¯æœåŠ¡
sudo systemctl start secondhand-backend    # å¯åŠ¨
sudo systemctl stop secondhand-backend     # åœæ­¢
sudo systemctl restart secondhand-backend  # é‡å¯
sudo systemctl status secondhand-backend   # çŠ¶æ€
sudo journalctl -u secondhand-backend -f   # æ—¥å¿—

# Nginx
sudo systemctl start nginx
sudo systemctl restart nginx
sudo systemctl status nginx

# MySQL
sudo systemctl start mysql
sudo systemctl status mysql

# Redis
sudo systemctl start redis-server
sudo systemctl status redis-server
```

### 2. æ—¥å¿—æŸ¥çœ‹

```bash
# Django æ—¥å¿—
tail -f /var/www/secondhand/backend/logs/django.log

# Nginx æ—¥å¿—
tail -f /var/log/nginx/secondhand_access.log
tail -f /var/log/nginx/secondhand_error.log

# ç³»ç»Ÿæ—¥å¿—
sudo journalctl -xe
```

### 3. æ€§èƒ½ç›‘æ§

å®‰è£…ç›‘æ§å·¥å…·ï¼ˆå¯é€‰ï¼‰ï¼š
```bash
# å®‰è£… htopï¼ˆè¿›ç¨‹ç›‘æ§ï¼‰
sudo apt install -y htop

# æŸ¥çœ‹ç³»ç»Ÿèµ„æº
htop

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
df -h

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h
```

---

## ğŸ’¾ å¤‡ä»½å’Œå®‰å…¨

### 1. æ•°æ®åº“å¤‡ä»½

åˆ›å»ºå¤‡ä»½è„šæœ¬ï¼š
```bash
vim /var/www/secondhand/backup_db.sh
```

æ·»åŠ ï¼š
```bash
#!/bin/bash
BACKUP_DIR="/var/www/secondhand/backups"
DATE=$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR

# å¤‡ä»½æ•°æ®åº“
mysqldump -u dbuser -pä½ çš„å¯†ç  secondhand_platform > $BACKUP_DIR/db_$DATE.sql

# å‹ç¼©å¤‡ä»½
gzip $BACKUP_DIR/db_$DATE.sql

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "db_*.sql.gz" -mtime +7 -delete

echo "æ•°æ®åº“å¤‡ä»½å®Œæˆ: db_$DATE.sql.gz"
```

è®¾ç½®æƒé™å¹¶æ·»åŠ åˆ°å®šæ—¶ä»»åŠ¡ï¼š
```bash
chmod +x /var/www/secondhand/backup_db.sh

# æ·»åŠ åˆ° crontabï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½ï¼‰
crontab -e
# æ·»åŠ ï¼š
0 2 * * * /var/www/secondhand/backup_db.sh
```

### 2. æ–‡ä»¶å¤‡ä»½

```bash
# å¤‡ä»½åª’ä½“æ–‡ä»¶
tar -czf /var/www/secondhand/backups/media_$(date +%Y%m%d).tar.gz /var/www/secondhand/backend/media
```

### 3. å®‰å…¨åŠ å›º

```bash
# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# é…ç½® SSH å¯†é’¥ç™»å½•ï¼ˆæ¯”å¯†ç æ›´å®‰å…¨ï¼‰
# åœ¨æœ¬åœ°ç”Ÿæˆå¯†é’¥å¯¹
ssh-keygen -t rsa

# ä¸Šä¼ å…¬é’¥åˆ°æœåŠ¡å™¨
ssh-copy-id ä½ çš„ç”¨æˆ·å@æœåŠ¡å™¨IP

# ç¦ç”¨å¯†ç ç™»å½•ï¼ˆå¯é€‰ï¼Œé…ç½®å¥½å¯†é’¥åï¼‰
sudo vim /etc/ssh/sshd_config
# è®¾ç½®ï¼šPasswordAuthentication no
sudo systemctl restart sshd
```

---

## ğŸ› å¸¸è§é—®é¢˜

### 1. 502 Bad Gateway

**åŸå› **ï¼šåç«¯æœåŠ¡æœªå¯åŠ¨æˆ–ç«¯å£é”™è¯¯

**è§£å†³**ï¼š
```bash
# æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€
sudo systemctl status secondhand-backend

# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
sudo netstat -tlnp | grep 8000

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
sudo journalctl -u secondhand-backend -n 50
```

### 2. é™æ€æ–‡ä»¶ 404

**åŸå› **ï¼šé™æ€æ–‡ä»¶æœªæ”¶é›†æˆ–è·¯å¾„é”™è¯¯

**è§£å†³**ï¼š
```bash
cd /var/www/secondhand/backend
source venv/bin/activate
python manage.py collectstatic --noinput

# æ£€æŸ¥æ–‡ä»¶æƒé™
sudo chown -R www-data:www-data /var/www/secondhand/backend/static
```

### 3. æ•°æ®åº“è¿æ¥å¤±è´¥

**åŸå› **ï¼šæ•°æ®åº“é…ç½®é”™è¯¯æˆ–æœåŠ¡æœªå¯åŠ¨

**è§£å†³**ï¼š
```bash
# æ£€æŸ¥ MySQL æœåŠ¡
sudo systemctl status mysql

# æµ‹è¯•æ•°æ®åº“è¿æ¥
mysql -u dbuser -p -h 127.0.0.1 secondhand_platform

# æ£€æŸ¥é˜²ç«å¢™
sudo ufw status
```

### 4. WebSocket è¿æ¥å¤±è´¥

**åŸå› **ï¼šNginx æœªæ­£ç¡®é…ç½® WebSocket æ”¯æŒ

**è§£å†³**ï¼šæ£€æŸ¥ Nginx é…ç½®ä¸­çš„ `/ws` å’Œ `/api` location æ˜¯å¦åŒ…å« WebSocket å¤´ã€‚

### 5. å†…å­˜ä¸è¶³

**åŸå› **ï¼šæœåŠ¡å™¨å†…å­˜å¤ªå°æˆ–åº”ç”¨å ç”¨è¿‡å¤š

**è§£å†³**ï¼š
```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h
htop

# ä¼˜åŒ– Gunicorn workersï¼ˆå¦‚æœä½¿ç”¨ï¼‰
# å‡å°‘ workers æ•°é‡
```

---

## ğŸ“š éƒ¨ç½²æ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰
- [ ] äº‘æœåŠ¡å™¨å·²è´­ä¹°å¹¶é…ç½®
- [ ] åŸŸåå·²è´­ä¹°å¹¶è§£æï¼ˆå¯é€‰ï¼‰
- [ ] å®‰å…¨ç»„ç«¯å£å·²å¼€æ”¾
- [ ] SSH å¯ä»¥è¿æ¥æœåŠ¡å™¨

### ç¯å¢ƒé…ç½®
- [ ] Python 3.10+ å·²å®‰è£…
- [ ] Node.js 18+ å·²å®‰è£…
- [ ] MySQL 8.0 å·²å®‰è£…å¹¶é…ç½®
- [ ] Redis å·²å®‰è£…å¹¶é…ç½®
- [ ] Nginx å·²å®‰è£…

### é¡¹ç›®éƒ¨ç½²
- [ ] ä»£ç å·²ä¸Šä¼ åˆ°æœåŠ¡å™¨
- [ ] è™šæ‹Ÿç¯å¢ƒå·²åˆ›å»º
- [ ] ä¾èµ–å·²å®‰è£…
- [ ] ç¯å¢ƒå˜é‡å·²é…ç½®
- [ ] æ•°æ®åº“å·²è¿ç§»
- [ ] é™æ€æ–‡ä»¶å·²æ”¶é›†

### æœåŠ¡é…ç½®
- [ ] åç«¯æœåŠ¡å·²é…ç½® systemd
- [ ] åç«¯æœåŠ¡å¯ä»¥æ­£å¸¸å¯åŠ¨
- [ ] å‰ç«¯å·²æ„å»º
- [ ] Nginx é…ç½®æ­£ç¡®
- [ ] SSL è¯ä¹¦å·²é…ç½®ï¼ˆå¦‚æœä½¿ç”¨åŸŸåï¼‰

### æµ‹è¯•
- [ ] å¯ä»¥è®¿é—®ç½‘ç«™é¦–é¡µ
- [ ] API æ¥å£æ­£å¸¸
- [ ] é™æ€æ–‡ä»¶å¯ä»¥åŠ è½½
- [ ] æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½æ­£å¸¸
- [ ] WebSocket è¿æ¥æ­£å¸¸ï¼ˆå¦‚æœæœ‰ï¼‰
- [ ] æ”¯ä»˜åŠŸèƒ½æ­£å¸¸ï¼ˆå¦‚æœæœ‰ï¼‰

---

## ğŸ‰ å®Œæˆï¼

æ­å–œï¼ä½ çš„é¡¹ç›®å·²ç»æˆåŠŸéƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨äº†ï¼

**è®¿é—®åœ°å€**ï¼š
- HTTPï¼šhttp://ä½ çš„åŸŸåæˆ–IP
- HTTPSï¼šhttps://ä½ çš„åŸŸåï¼ˆå¦‚æœé…ç½®äº†SSLï¼‰

**åç»­ç»´æŠ¤**ï¼š
1. å®šæœŸæ›´æ–°ç³»ç»Ÿå’Œä¾èµ–
2. å®šæœŸå¤‡ä»½æ•°æ®åº“å’Œæ–‡ä»¶
3. ç›‘æ§æœåŠ¡å™¨èµ„æºä½¿ç”¨
4. æŸ¥çœ‹æ—¥å¿—æ’æŸ¥é—®é¢˜

ç¥éƒ¨ç½²é¡ºåˆ©ï¼ğŸš€




