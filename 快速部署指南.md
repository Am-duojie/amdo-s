# 🚀 快速部署指南 - 本地部署外网访问

## 5分钟快速开始

### 前提条件
- ✅ 项目已配置好，本地可以正常运行
- ✅ MySQL 数据库已创建
- ✅ Redis 已安装（WebSocket 需要）

---

## 📋 方案对比

| 方案 | 难度 | 速度 | 稳定性 | 推荐度 |
|------|------|------|--------|--------|
| **Ngrok（推荐）** | ⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **Natapp** | ⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ |
| **路由器端口转发** | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| **云服务器** | ⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |

**个人开发首选：Ngrok 或 Natapp**

---

## 🎯 使用 Ngrok（推荐）

### 步骤 1：注册 Ngrok

1. 访问：https://ngrok.com/
2. 注册免费账号（使用 GitHub 账号快速登录）
3. 获取 authtoken（在 Dashboard 中）

### 步骤 2：安装和配置 Ngrok

**方式 A：下载安装**
- 下载 ngrok.exe（Windows）
- 解压到项目目录或系统 PATH

**方式 B：使用包管理器**
```bash
# 如果有 Chocolatey
choco install ngrok

# 如果有 Scoop
scoop install ngrok
```

**配置 authtoken**：
```bash
ngrok config add-authtoken 你的authtoken
```

### 步骤 3：启动后端服务

打开 PowerShell 或 CMD：
```bash
cd backend

# 激活虚拟环境
venv\Scripts\activate

# 启动后端（使用生产配置）
set DJANGO_SETTINGS_MODULE=core.settings_production
python manage.py runserver 0.0.0.0:8000

# 或者使用提供的脚本
start_production.bat
```

### 步骤 4：启动 Ngrok

**新开一个终端窗口**：
```bash
# 映射 8000 端口
ngrok http 8000
```

启动后，你会看到类似这样的输出：
```
Forwarding  https://abc123.ngrok-free.app -> http://localhost:8000
```

**复制这个 HTTPS 地址**（例如：`https://abc123.ngrok-free.app`）

### 步骤 5：配置项目

#### 5.1 修改后端配置

编辑 `backend/core/settings_production.py`：

```python
ALLOWED_HOSTS = [
    'localhost',
    '127.0.0.1',
    'abc123.ngrok-free.app',  # 替换为你的 ngrok 地址（不含 https://）
    '*.ngrok-free.app',       # 或者使用通配符
]

CORS_ALLOWED_ORIGINS = [
    "http://localhost:5173",
    "https://你的前端ngrok地址.ngrok-free.app",  # 如果有前端穿透
]
```

#### 5.2 修改支付回调地址

如果使用支付功能，编辑 `backend/core/settings_production.py`：

```python
EASYPAY_NOTIFY_URL = 'https://abc123.ngrok-free.app/api/payment/notify/'
EASYPAY_RETURN_URL = 'https://你的前端地址/order/'
```

#### 5.3 前端配置（如果前端也要穿透）

如果需要前端也能外网访问：

**新开终端，映射前端端口**：
```bash
ngrok http 5173
```

**修改前端 API 地址**：

创建或编辑 `frontend/.env.production`：
```env
VITE_API_URL=https://abc123.ngrok-free.app/api
```

**重新构建前端**：
```bash
cd frontend
npm run build
```

### 步骤 6：测试访问

1. **本地测试**：
   - 后端：http://localhost:8000/api
   - 前端：http://localhost:5173

2. **外网测试**：
   - 使用手机连接其他 WiFi 或移动网络
   - 访问：`https://你的ngrok地址/api`
   - 或访问前端地址（如果有配置）

---

## 🎯 使用 Natapp（国内推荐）

### 步骤 1：注册 Natapp

1. 访问：https://natapp.cn/
2. 注册账号

### 步骤 2：创建隧道

1. 登录后，点击"购买隧道"
2. 选择"免费隧道"
3. 配置：
   - 本地端口：8000
   - 协议：http
4. 获取 authtoken

### 步骤 3：下载客户端

1. 下载 Windows 版本
2. 解压到项目目录

### 步骤 4：启动服务

**启动后端**：
```bash
cd backend
start_production.bat
```

**启动 Natapp**（新终端）：
```bash
# 方式1：使用 authtoken
natapp -authtoken=你的authtoken 8000

# 方式2：使用配置文件
# 创建 config.ini：
# [default]
# authtoken=你的authtoken
natapp -config=config.ini
```

### 步骤 5：配置项目

和 Ngrok 类似，将域名替换为 natapp 给的地址即可。

---

## 🔧 使用启动脚本（推荐）

项目已提供启动脚本，方便使用：

### Windows 脚本说明

| 脚本 | 说明 |
|------|------|
| `start_all.bat` | 一键启动前后端（开发环境） |
| `backend/start_production.bat` | 启动后端生产环境服务 |
| `backend/start_ngrok.bat` | 启动 Ngrok 内网穿透 |

### 使用方式

**完整流程**：

1. **启动后端服务**：
   ```bash
   cd backend
   start_production.bat
   ```

2. **新终端启动内网穿透**：
   ```bash
   cd backend
   start_ngrok.bat
   ```
   或手动运行：
   ```bash
   ngrok http 8000
   ```

3. **复制 ngrok 给的地址**，配置到项目

4. **启动前端**（如果需要）：
   ```bash
   cd frontend
   npm run dev
   ```

---

## ⚙️ 生产环境配置说明

### 使用生产环境配置

项目已创建 `backend/core/settings_production.py`，包含：

- ✅ `DEBUG = False` - 关闭调试模式
- ✅ 安全配置优化
- ✅ 日志配置
- ✅ 环境变量支持

### 切换配置

**方式 1：使用环境变量**
```bash
set DJANGO_SETTINGS_MODULE=core.settings_production
python manage.py runserver
```

**方式 2：使用启动脚本**
```bash
start_production.bat  # 脚本已配置
```

**方式 3：临时修改 settings.py**
- 将 `DEBUG = True` 改为 `False`
- 修改 `ALLOWED_HOSTS`

---

## 🔐 重要配置项

### 必须修改的配置

1. **ALLOWED_HOSTS** - 必须包含你的外网地址
2. **CORS_ALLOWED_ORIGINS** - 必须包含前端地址
3. **支付回调地址** - 必须使用公网地址

### 安全建议

1. **修改 SECRET_KEY**：
   ```python
   # 生成新密钥
   python -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())"
   ```

2. **使用环境变量管理敏感信息**：
   ```bash
   set SECRET_KEY=你的密钥
   set DB_PASSWORD=数据库密码
   ```

3. **定期更新依赖**：
   ```bash
   pip list --outdated
   pip install --upgrade 包名
   ```

---

## 🐛 常见问题

### 1. CORS 跨域错误

**症状**：前端访问后端 API 时报 CORS 错误

**解决**：
- 检查 `CORS_ALLOWED_ORIGINS` 是否包含前端地址
- 确保使用完整的 URL（包括协议）
- 临时测试可以使用 `CORS_ALLOW_ALL_ORIGINS = True`

### 2. 404 错误

**症状**：访问外网地址返回 404

**解决**：
- 检查 `ALLOWED_HOSTS` 是否包含域名
- 确认 ngrok/natapp 是否正常运行
- 检查后端服务是否启动

### 3. WebSocket 连接失败

**症状**：即时消息功能无法使用

**解决**：
- 确保 Redis 服务已启动
- 确认使用 Daphne 而不是 runserver（WebSocket 需要）
- 检查内网穿透工具是否支持 WebSocket（ngrok 支持）

### 4. 静态文件 404

**症状**：CSS、JS 文件无法加载

**解决**：
```bash
# 收集静态文件
python manage.py collectstatic --noinput
```

### 5. 支付回调失败

**症状**：支付后无法收到回调

**解决**：
- 确保回调地址是 HTTPS（ngrok 免费版支持）
- 检查 `EASYPAY_NOTIFY_URL` 配置
- 查看服务器日志

---

## 📱 测试检查清单

部署完成后，请测试以下功能：

- [ ] 外网可以访问后端 API
- [ ] 用户注册/登录功能正常
- [ ] 商品列表可以加载
- [ ] 图片可以正常显示
- [ ] WebSocket 消息功能正常（如果有）
- [ ] 支付功能正常（如果有）
- [ ] 文件上传功能正常

---

## 💡 提示

1. **免费版限制**：
   - Ngrok 免费版域名每次启动会变化
   - 有并发连接数限制
   - 适合开发和测试

2. **性能优化**：
   - 生产环境建议使用 Gunicorn 或 Daphne
   - 配置 Nginx 反向代理
   - 启用静态文件缓存

3. **域名固定**：
   - Ngrok 付费版可以固定域名
   - 或使用自己的域名配置 DNS

4. **长期运行**：
   - 使用 Windows 服务或任务计划程序
   - 或使用 Supervisor（Linux）
   - 确保服务意外退出后自动重启

---

## 📚 相关文档

- 详细部署指南：`本地部署外网访问指南.md`
- 项目 README：`README.md`
- Django 部署文档：https://docs.djangoproject.com/en/stable/howto/deployment/

---

## 🎉 完成！

如果一切顺利，你的项目现在应该可以通过外网访问了！

**记住**：
- ✅ 内网穿透工具运行时，外网才能访问
- ✅ 关闭工具后，外网无法访问
- ✅ 免费版域名可能每次启动都变化
- ✅ 生产环境建议使用固定域名或云服务器

祝你部署顺利！🚀




