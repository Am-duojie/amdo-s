# 配置修改完成

## 已完成的修改

### 1. 后端配置 (`backend/core/settings.py`)

**修改前**：
```python
FRONTEND_URL = 'https://georgianna-presanitary-clair.ngrok-free.dev'  # 前端 ngrok 地址
```

**修改后**：
```python
FRONTEND_URL = 'http://localhost:5173'  # 前端本地地址
BACKEND_URL = 'https://hypochondriacally-nondiscretionary-kylie.ngrok-free.dev'  # 后端 ngrok 地址
```

## 当前配置

### 前端
- **地址**：`http://localhost:5173`（本地地址）
- **访问方式**：本地浏览器直接访问
- **不需要 ngrok**：前端不映射到公网

### 后端
- **地址**：`https://hypochondriacally-nondiscretionary-kylie.ngrok-free.dev`（ngrok 公网地址）
- **访问方式**：通过 ngrok 公网访问
- **需要 ngrok**：后端必须保持 ngrok 运行

## 支付回调流程

由于前端是 localhost，后端是 ngrok，支付回调会自动使用后端重定向页面：

1. **用户支付完成** → 支付宝跳转到后端重定向页面
2. **后端重定向页面** → `https://hypochondriacally-nondiscretionary-kylie.ngrok-free.dev/api/payment/redirect/`
3. **后端重定向** → 前端支付回调页面 `http://localhost:5173/payment/return`
4. **前端查询支付状态** → 调用后端 API（通过 vite proxy）
5. **跳转到订单详情页**

## 回调地址

### 异步通知地址（notify_url）

```
https://hypochondriacally-nondiscretionary-kylie.ngrok-free.dev/api/payment/alipay/notify/
```

### 同步返回地址（return_url）

```
https://hypochondriacally-nondiscretionary-kylie.ngrok-free.dev/api/payment/redirect?order_id={order_id}&order_type={order_type}
```

后端重定向页面会自动跳转到前端 `http://localhost:5173/payment/return`。

## 前端 API 配置

前端代码会自动处理：

- **本地访问**：使用 `http://127.0.0.1:8000/api`（通过 vite proxy）
- **不需要额外配置**：前端在本地运行，API 请求通过 vite proxy 转发到本地后端

## 启动服务

### 1. 启动后端 ngrok（必须）

```powershell
cd D:\AAA\毕业设计\backend
ngrok start --config ngrok-backend.yml --region ap backend
```

### 2. 启动 Django 后端

```powershell
cd D:\AAA\毕业设计\backend
python manage.py runserver
```

### 3. 启动前端服务（本地）

```powershell
cd D:\AAA\毕业设计\frontend
npm run dev
```

### 4. 访问前端

在浏览器中访问：`http://localhost:5173`

## 验证配置

### 1. 验证后端

访问：`https://hypochondriacally-nondiscretionary-kylie.ngrok-free.dev/api/`

应该看到 API 根目录的 JSON 响应。

### 2. 验证前端

访问：`http://localhost:5173`

应该能看到前端页面，并且能正常加载数据。

### 3. 验证 API 连接

在浏览器控制台（访问前端后）检查网络请求，应该能看到 API 请求发送到 `http://127.0.0.1:8000/api`（通过 vite proxy）。

## 优势

1. **简单**：前端不需要 ngrok，只需本地运行
2. **快速**：本地访问前端，速度更快
3. **安全**：前端不暴露到公网
4. **灵活**：后端通过 ngrok 暴露，可以接收支付宝回调

## 注意事项

1. **前端必须本地运行**：前端服务必须在本地运行（`npm run dev`）
2. **后端 ngrok 必须运行**：后端 ngrok 必须保持运行，否则支付宝无法回调
3. **地址变化**：如果后端 ngrok 地址变化，需要更新 `settings.py` 中的 `BACKEND_URL`
4. **CORS 配置**：确保后端 `CORS_ALLOW_ALL_ORIGINS = True`，允许前端本地访问

## 代码自动处理

支付回调逻辑会自动检测配置：

- 检测到前端是 `localhost`，后端是 `ngrok`
- 自动使用后端重定向页面作为 `return_url`
- 后端重定向页面会自动跳转到前端本地地址

无需手动修改支付回调代码！







