# 支付回调地址配置说明

## 配置位置

支付回调地址在以下位置配置：

### 1. 基础 URL 配置

**文件**：`backend/core/settings.py`

```python
# 前端地址配置
FRONTEND_URL = 'https://georgianna-presanitary-clair.ngrok-free.dev'  # 前端 ngrok 地址

# 后端地址（使用 ngrok 内网穿透地址）
BACKEND_URL = 'https://hypochondriacally-nondiscretionary-kylie.ngrok-free.dev'  # 后端 ngrok 地址
```

### 2. 回调地址动态构建

**文件**：`backend/app/secondhand_app/payment_views.py`

在 `create_payment` 函数中（第 68-109 行）动态构建回调地址：

```python
# 获取基础 URL
frontend_url = getattr(settings, 'FRONTEND_URL', 'http://localhost:5173')
backend_url = getattr(settings, 'BACKEND_URL', 'http://127.0.0.1:8000')

# 构建 return_url（同步返回地址）
# 根据前后端配置自动选择最佳方案
if frontend_is_ngrok:
    # 前端是 ngrok 地址，直接跳转到前端
    return_url = f'{frontend_url}/payment/return?order_id={order.id}&order_type=normal'
elif backend_is_ngrok and frontend_is_localhost:
    # 后端是 ngrok，前端是 localhost，使用后端重定向页面
    return_url = f'{backend_url}/api/payment/redirect?order_id={order.id}&order_type=normal'
else:
    # 其他情况，直接跳转到前端
    return_url = f'{frontend_url}/payment/return?order_id={order.id}&order_type=normal'

# 构建 notify_url（异步通知地址）
notify_url = f'{backend_url}/api/payment/alipay/notify/'
```

## 回调地址说明

### 1. 异步通知地址（notify_url）

**地址**：`{BACKEND_URL}/api/payment/alipay/notify/`

**当前配置**：
```
https://hypochondriacally-nondiscretionary-kylie.ngrok-free.dev/api/payment/alipay/notify/
```

**说明**：
- 支付宝服务器主动通知支付结果
- 必须公网可访问（使用 ngrok 地址）
- 处理函数：`payment_views.alipay_payment_notify`
- URL 路由：`/api/payment/alipay/notify/`（在 `backend/core/urls.py` 中定义）

### 2. 同步返回地址（return_url）

**地址**：根据配置动态构建

**当前配置**（前端是 ngrok 地址）：
```
https://georgianna-presanitary-clair.ngrok-free.dev/payment/return?order_id={order_id}&order_type={order_type}
```

**说明**：
- 用户支付完成后跳转的页面
- 根据前后端配置自动选择：
  - 如果前端是 ngrok：直接跳转到前端
  - 如果前端是 localhost：通过后端重定向页面跳转
- 前端处理页面：`frontend/src/pages/PaymentReturn.vue`
- 前端路由：`/payment/return`（在 `frontend/src/router/index.js` 中定义）

## 配置策略

代码会根据以下策略自动选择回调地址：

### 策略 1：前端是 ngrok 地址（当前配置）

```python
if frontend_is_ngrok:
    return_url = f'{frontend_url}/payment/return?order_id={order.id}&order_type=normal'
```

**流程**：
1. 支付宝 → 前端支付回调页面
2. 前端查询支付状态
3. 跳转到订单详情页

### 策略 2：前端是 localhost，后端是 ngrok

```python
elif backend_is_ngrok and frontend_is_localhost:
    return_url = f'{backend_url}/api/payment/redirect?order_id={order.id}&order_type=normal'
```

**流程**：
1. 支付宝 → 后端重定向页面（`/api/payment/redirect/`）
2. 后端重定向页面 → 前端支付回调页面
3. 前端查询支付状态
4. 跳转到订单详情页

### 策略 3：其他情况

```python
else:
    return_url = f'{frontend_url}/payment/return?order_id={order.id}&order_type=normal'
```

## 当前配置状态

根据 `settings.py` 的配置：

- **FRONTEND_URL**: `https://georgianna-presanitary-clair.ngrok-free.dev`
- **BACKEND_URL**: `https://hypochondriacally-nondiscretionary-kylie.ngrok-free.dev`

**实际回调地址**：

1. **notify_url**（异步通知）：
   ```
   https://hypochondriacally-nondiscretionary-kylie.ngrok-free.dev/api/payment/alipay/notify/
   ```

2. **return_url**（同步返回）：
   ```
   https://georgianna-presanitary-clair.ngrok-free.dev/payment/return?order_id={order_id}&order_type={order_type}
   ```

## 修改回调地址

### 方法 1：修改基础 URL（推荐）

修改 `backend/core/settings.py`：

```python
FRONTEND_URL = 'https://新的前端地址.ngrok-free.dev'
BACKEND_URL = 'https://新的后端地址.ngrok-free.dev'
```

回调地址会自动更新。

### 方法 2：直接修改代码（不推荐）

如果需要自定义回调地址逻辑，可以修改 `backend/app/secondhand_app/payment_views.py` 中的 `create_payment` 函数。

## 验证回调地址

### 1. 查看日志

创建支付订单时，查看 Django 日志，应该能看到：

```
使用前端 ngrok 地址作为 return_url: https://georgianna-presanitary-clair.ngrok-free.dev/payment/return?order_id=xxx&order_type=normal
```

### 2. 测试异步通知

访问异步通知地址（应该返回 405 或错误，因为需要 POST 请求）：
```
https://hypochondriacally-nondiscretionary-kylie.ngrok-free.dev/api/payment/alipay/notify/
```

### 3. 测试同步返回

访问同步返回地址（应该能看到支付回调页面）：
```
https://georgianna-presanitary-clair.ngrok-free.dev/payment/return?order_id=xxx&order_type=normal
```

## 相关文件

- **基础配置**：`backend/core/settings.py`（第 281-286 行）
- **回调地址构建**：`backend/app/secondhand_app/payment_views.py`（第 68-109 行）
- **异步通知处理**：`backend/app/secondhand_app/payment_views.py`（`alipay_payment_notify` 函数）
- **URL 路由**：`backend/core/urls.py`（第 50-51 行）
- **前端回调页面**：`frontend/src/pages/PaymentReturn.vue`
- **前端路由**：`frontend/src/router/index.js`

## 注意事项

1. **notify_url 必须公网可访问**：支付宝服务器需要能够访问
2. **return_url 可以是前端地址**：用户浏览器跳转，可以是前端地址
3. **地址变化**：每次重启 ngrok，地址可能变化，需要更新 `settings.py`
4. **HTTPS**：ngrok 使用 HTTPS，确保所有地址使用 `https://`







