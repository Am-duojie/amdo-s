# 爱回收完整数据爬取导入指南

本指南说明如何从爱回收网站爬取完整的商品数据（包括图片、详情、质检报告）并导入到数据库。

## 方法一：使用Playwright自动爬取（推荐）

### 1. 安装依赖

```bash
pip install playwright
playwright install chromium
```

### 2. 爬取单个商品

```bash
python manage.py crawl_aihuishou_full \
  --url "https://m.aihuishou.com/n/ofn/strict-selected/product/detail?saleGoodsNo=20251130153758487586" \
  --out "data/aihuishou_full.json"
```

### 3. 爬取多个商品

```bash
python manage.py crawl_aihuishou_full \
  --urls "https://m.aihuishou.com/n/ofn/strict-selected/product/detail?saleGoodsNo=xxx1" \
         "https://m.aihuishou.com/n/ofn/strict-selected/product/detail?saleGoodsNo=xxx2" \
  --out "data/aihuishou_full.json"
```

### 4. 导入数据

```bash
python manage.py import_aihuishou_full \
  --file "data/aihuishou_full.json" \
  --username aihuishou \
  --download-images
```

## 方法二：使用浏览器手动获取数据

如果Playwright无法访问网站，可以使用浏览器手动获取数据：

### 1. 在浏览器中打开商品详情页

打开爱回收商品详情页，例如：
```
https://m.aihuishou.com/n/ofn/strict-selected/product/detail?saleGoodsNo=20251130153758487586
```

### 2. 在浏览器控制台运行提取脚本

按 `F12` 打开开发者工具，在控制台中运行以下脚本：

```javascript
// 提取商品完整数据
(function() {
    const data = {
        title: '',
        price: 0,
        original_price: null,
        new_price: null,
        condition: '',
        description: '',
        brand: '',
        model: '',
        storage: '',
        screen_size: '',
        battery_health: '',
        charging_type: '',
        specifications: {},
        quality_report: {},
        images: [],
        detail_images: []
    };

    // 提取标题
    const titleSelectors = ['h1', '.title', '[class*="title"]', '[class*="name"]'];
    for (const sel of titleSelectors) {
        const el = document.querySelector(sel);
        if (el && el.textContent.trim().length > 5) {
            data.title = el.textContent.trim();
            break;
        }
    }

    // 提取价格
    const priceText = document.body.textContent || '';
    const priceMatches = priceText.match(/[￥¥]\s*(\d+(?:,\d{3})*(?:\.\d+)?)/g);
    if (priceMatches) {
        const prices = priceMatches.map(m => parseFloat(m.replace(/[￥¥,\s]/g, '')));
        data.price = prices[0] || 0;
        if (prices.length > 1) {
            data.original_price = prices[1];
        }
        if (prices.length > 2) {
            data.new_price = prices[2];
        }
    }

    // 提取成色
    const conditionText = priceText.match(/(\d+)成新|(\d+)%|(全新|99新|95新|9成新|8成新)/);
    if (conditionText) {
        data.condition = conditionText[0];
    }

    // 提取品牌和型号
    if (data.title) {
        const brandMatch = data.title.match(/(苹果|Apple|华为|Huawei|小米|Xiaomi|OPPO|vivo|荣耀|Honor|三星|Samsung|联想|Lenovo|戴尔|Dell|华硕|ASUS)/i);
        if (brandMatch) {
            data.brand = brandMatch[1];
        }
        const modelMatch = data.title.match(/(iPhone\s+\d+|Mate\s+\d+|P\d+|Redmi|MacBook|iPad|Watch|AirPods)/i);
        if (modelMatch) {
            data.model = modelMatch[1];
        }
        const storageMatch = data.title.match(/(\d+GB|\d+TB)/i);
        if (storageMatch) {
            data.storage = storageMatch[1];
        }
    }

    // 提取所有图片
    const allImages = [];
    document.querySelectorAll('img').forEach(img => {
        if (img.src && !img.src.includes('data:image') && img.src.length > 50) {
            if (!img.src.includes('logo') && !img.src.includes('icon') && 
                !img.src.includes('avatar') && !img.src.includes('placeholder')) {
                const width = img.width || img.naturalWidth || 0;
                const height = img.height || img.naturalHeight || 0;
                if (width > 100 || height > 100) {
                    allImages.push(img.src);
                }
            }
        }
    });
    data.images = [...new Set(allImages)].slice(0, 15);

    // 提取规格参数
    const specText = document.body.textContent || '';
    const screenMatch = specText.match(/(\d+\.?\d*英寸)/);
    if (screenMatch) {
        data.screen_size = screenMatch[1];
    }

    const batteryMatch = specText.match(/(\d+-\d+%|\d+%|电池效率[：:](\d+-\d+%|\d+%))/);
    if (batteryMatch) {
        data.battery_health = batteryMatch[1] || batteryMatch[2] || '';
    }

    const chargingMatch = specText.match(/(Lightning|Type-C|USB-C|MagSafe|无线充电|磁吸充电)/);
    if (chargingMatch) {
        data.charging_type = chargingMatch[1];
    }

    // 提取描述
    const descSelectors = ['.description', '.desc', '[class*="desc"]', '.detail', '[class*="detail"]', '.content'];
    for (const sel of descSelectors) {
        const el = document.querySelector(sel);
        if (el && el.textContent.trim().length > 20) {
            data.description = el.textContent.trim().substring(0, 2000);
            break;
        }
    }
    if (!data.description) {
        const bodyText = document.body.textContent || '';
        const descMatch = bodyText.match(/(.{50,500})/);
        if (descMatch) {
            data.description = descMatch[1].substring(0, 500);
        }
    }

    // 提取质检报告
    const reportText = document.body.textContent || '';
    const reportData = {};
    
    const reportNumMatch = reportText.match(/报告编号[：:]([A-Z0-9]+)/);
    if (reportNumMatch) {
        reportData['report_number'] = reportNumMatch[1];
    }
    
    const timeMatch = reportText.match(/质检时间[：:]([\d\.]+)/);
    if (timeMatch) {
        reportData['inspection_time'] = timeMatch[1];
    }
    
    const resultMatch = reportText.match(/验机结果[：:]([^\n]+)/);
    if (resultMatch) {
        reportData['inspection_result'] = resultMatch[1];
    }
    
    const imeiMatch = reportText.match(/IMEI\/SN[：:]([\d\*]+)/);
    if (imeiMatch) {
        reportData['imei'] = imeiMatch[1];
    }
    
    const activeMatch = reportText.match(/激活日期[：:]([\d\/]+)/);
    if (activeMatch) {
        reportData['activation_date'] = activeMatch[1];
    }

    data.quality_report = reportData;
    data.url = window.location.href;
    data.platform = '爱回收';
    data.category = '手机'; // 根据实际情况修改

    // 输出JSON
    console.log(JSON.stringify(data, null, 2));
    
    // 复制到剪贴板（如果支持）
    if (navigator.clipboard) {
        navigator.clipboard.writeText(JSON.stringify(data, null, 2));
        console.log('数据已复制到剪贴板！');
    }
    
    return data;
})();
```

### 3. 保存数据

将控制台输出的JSON数据保存到文件，例如 `data/aihuishou_manual.json`。

### 4. 导入数据

```bash
python manage.py import_from_browser \
  --file "data/aihuishou_manual.json" \
  --username aihuishou
```

或者直接提供JSON数据：

```bash
python manage.py import_from_browser \
  --data '{"title":"苹果 iPhone 14 Pro 256G","price":2959,"images":["https://..."],...}' \
  --username aihuishou
```

## 方法三：批量爬取商品列表

使用现有的爬虫命令批量爬取：

```bash
python manage.py crawl_aihuishou \
  --categories "手机,电脑,平板,手表,耳机" \
  --per-category 20 \
  --detail \
  --delay 3.0 \
  --out "data/aihuishou_batch.json"
```

然后导入：

```bash
python manage.py import_aihuishou_full \
  --file "data/aihuishou_batch.json" \
  --username aihuishou \
  --download-images
```

## 为现有商品下载图片

如果商品没有图片，可以使用以下命令为所有商品创建占位图片：

```bash
python manage.py download_verified_images --username aihuishou
```

或者为指定商品下载图片：

```bash
python manage.py download_verified_images \
  --product-id 1 \
  --image-urls "https://example.com/image1.jpg" "https://example.com/image2.jpg"
```

## 注意事项

1. **网络连接**：确保能够访问爱回收网站
2. **图片下载**：图片下载可能需要较长时间，建议使用 `--download-timeout` 设置超时时间
3. **数据质量**：自动爬取的数据可能包含HTML代码片段，导入命令会自动过滤无效数据
4. **法律风险**：爬取第三方网站数据可能违反服务条款，请谨慎使用，仅用于学习研究

## 常见问题

### Q: 爬取失败，显示连接错误
A: 可能是网络问题或网站反爬虫机制，建议使用方法二（浏览器手动获取）

### Q: 图片下载失败
A: 检查图片URL是否有效，或使用 `--skip-images` 跳过图片下载，后续再使用 `download_verified_images` 命令下载

### Q: 导入的数据没有图片
A: 运行 `python manage.py download_verified_images` 为所有商品创建占位图片

