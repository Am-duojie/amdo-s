# 解决 Ngrok 冲突的实用方法

## 问题根源

配置文件格式已经正确，但冲突仍然存在，原因是：
- **ngrok 服务器端资源未释放**：即使本地进程停止，服务器端可能还在占用
- **免费版限制**：同一个 authtoken 可能分配到相同地址
- **时间太短**：需要等待更长时间（5-10 分钟）

## 实用解决方案

### 方案 1：分时启动（推荐）

**不要同时启动两个 ngrok**，而是：

1. **先启动后端，等待完全启动后再启动前端**

```powershell
# 终端 1 - 启动后端
cd D:\AAA\毕业设计\backend
ngrok start --config ngrok-backend.yml backend

# 等待看到地址，例如：
# Forwarding  https://xxxx-backend.ngrok-free.dev -> http://localhost:8000

# 然后等待 30-60 秒

# 终端 2 - 启动前端（新开终端）
cd D:\AAA\毕业设计\backend
ngrok start --config ngrok-frontend.yml frontend
```

### 方案 2：只使用一个 ngrok（最简单）

**只启动后端 ngrok**，前端继续使用 localhost：

```python
# settings.py
FRONTEND_URL = 'http://localhost:5173'  # 本地前端
BACKEND_URL = 'https://xxxx-backend.ngrok-free.dev'  # ngrok 后端
```

这样：
- 支付回调通过后端重定向页面处理
- 后端重定向页面会跳转回前端 localhost
- 不需要前端 ngrok

### 方案 3：使用不同的区域

修改配置文件，为前后端指定不同的区域：

**ngrok-backend.yml**:
```yaml
version: 3
agent:
  authtoken: 36TUDwWpJTqmuqX6TwUidfFZ8aL_3hNcLMa3t4T4dJgbrtcDq
tunnels:
  backend:
    addr: 8000
    proto: http
    region: us  # 美国
```

**ngrok-frontend.yml**:
```yaml
version: 3
agent:
  authtoken: 36TUDwWpJTqmuqX6TwUidfFZ8aL_3hNcLMa3t4T4dJgbrtcDq
tunnels:
  frontend:
    addr: 5173
    proto: http
    region: jp  # 日本（您当前使用的）
```

### 方案 4：完全清理并等待

```powershell
# 1. 停止所有进程
Get-Process ngrok | Stop-Process -Force

# 2. 等待 10 分钟（重要！）
Write-Host "等待 10 分钟..." -ForegroundColor Yellow
Start-Sleep -Seconds 600

# 3. 重新启动
cd D:\AAA\毕业设计\backend
ngrok start --config ngrok-backend.yml backend
```

## 推荐操作流程

### 立即执行：

```powershell
# 1. 完全停止
Get-Process ngrok | Stop-Process -Force

# 2. 等待 5 分钟
Write-Host "等待 5 分钟让服务器释放资源..." -ForegroundColor Yellow
Start-Sleep -Seconds 300

# 3. 先启动后端
cd D:\AAA\毕业设计\backend
ngrok start --config ngrok-backend.yml backend
```

**看到后端地址后，等待 60 秒，再启动前端。**

## 配置文件说明

配置文件格式已经正确：
- ✅ `version: 3`
- ✅ `agent.authtoken`
- ✅ `tunnels` 定义

**配置文件本身没有问题**，问题是 ngrok 服务器端的资源管理。

## 如果还是不行

考虑使用**方案 2**（只使用一个 ngrok），这是最简单可靠的方法：

1. 只启动后端 ngrok
2. 前端使用 localhost
3. 支付回调通过后端重定向页面处理

这样就不需要两个 ngrok 隧道了。




