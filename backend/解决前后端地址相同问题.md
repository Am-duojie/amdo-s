# 解决前后端 Ngrok 地址相同的问题

## 问题分析

如果前后端 ngrok 地址相同（例如都是 `https://hypochondriacally-nondiscretionary-kylie.ngrok-free.dev`），会出现以下问题：

1. **前端通过 ngrok 访问时**，API 请求如果使用相对路径 `/api`，会请求到同一个 ngrok 地址
2. **该地址映射到前端（5173端口）**，而不是后端（8000端口）
3. **前端服务器无法处理 `/api` 请求**，导致 API 调用失败

## 解决方案

### 方案 1：确保前后端使用不同的 ngrok 地址（推荐）

使用单个配置文件 `ngrok.yml` 启动所有隧道：

```powershell
cd D:\AAA\毕业设计\backend
ngrok start --all --config ngrok.yml
```

这会为每个隧道分配**不同的地址**：
- 后端：`https://xxxx-backend.ngrok-free.dev` → `http://localhost:8000`
- 前端：`https://yyyy-frontend.ngrok-free.dev` → `http://localhost:5173`

### 方案 2：如果地址仍然相同

如果使用 `--all` 后地址仍然相同，可能是 ngrok 免费版的限制。可以尝试：

#### 2.1 使用不同的区域

修改 `ngrok.yml`，为前后端指定不同的区域：

```yaml
version: 3
agent:
  authtoken: 36TUDwWpJTqmuqX6TwUidfFZ8aL_3hNcLMa3t4T4dJgbrtcDq
tunnels:
  backend:
    addr: 8000
    proto: http
    region: us  # 美国
  frontend:
    addr: 5173
    proto: http
    region: jp  # 日本
```

#### 2.2 分别启动（使用不同的配置文件）

如果单个配置文件仍然分配相同地址，可以分别启动：

```powershell
# 终端 1 - 后端
cd D:\AAA\毕业设计\backend
ngrok start --config ngrok-backend.yml backend

# 等待看到后端地址，然后等待 60 秒

# 终端 2 - 前端
cd D:\AAA\毕业设计\backend
ngrok start --config ngrok-frontend.yml frontend
```

### 方案 3：只使用后端 ngrok（最简单可靠）

如果无法获得不同的地址，可以：

1. **只启动后端 ngrok**
2. **前端继续使用 localhost**
3. **通过后端重定向页面处理支付回调**

配置：

```python
# settings.py
FRONTEND_URL = 'http://localhost:5173'  # 本地前端
BACKEND_URL = 'https://xxxx-backend.ngrok-free.dev'  # ngrok 后端
```

这样：
- 用户通过 ngrok 访问前端（但前端实际在 localhost）
- 前端 API 请求直接使用后端的 ngrok 地址
- 支付回调通过后端重定向页面处理

## 验证地址是否不同

启动 ngrok 后，检查输出：

```
Forwarding  https://xxxx-backend.ngrok-free.dev -> http://localhost:8000
Forwarding  https://yyyy-frontend.ngrok-free.dev -> http://localhost:5173
```

**两个地址必须不同！**

## 当前代码的处理

已修改的 `frontend/src/utils/api.js` 会：
1. 检测是否通过 ngrok 访问
2. 如果通过 ngrok 访问，使用 `localStorage` 中的 `BACKEND_NGROK_URL`
3. 如果未配置，使用相对路径 `/api`（这在前后端地址相同时会失败）

## 推荐操作

### 立即检查

1. **查看当前 ngrok 输出**，确认前后端地址是否不同
2. **如果相同**，停止所有 ngrok，等待 5 分钟，重新启动
3. **如果仍然相同**，使用方案 3（只使用后端 ngrok）

### 配置前端使用后端地址

即使前后端地址不同，也需要配置前端知道后端地址：

```javascript
// 在浏览器控制台运行
localStorage.setItem('BACKEND_NGROK_URL', 'https://您的后端ngrok地址.ngrok-free.dev')
location.reload()
```

## 如果地址确实相同

如果无论如何都无法获得不同的地址（可能是 ngrok 免费版的限制），建议：

1. **使用方案 3**：只使用后端 ngrok
2. **或者升级到付费版**：付费版支持多个独立隧道




