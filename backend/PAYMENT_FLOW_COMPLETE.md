# 打款流程完整实现文档

## 功能概述

后台管理系统在订单到达"已完成"状态后，可以在"打款信息"部分执行打款操作，将钱存入用户的易淘账户钱包中。

## 完整流程

### 1. 订单状态流转
```
pending (待估价) 
  ↓ [管理员给出预估价格]
quoted (已估价) 
  ↓ [用户确认]
confirmed (已确认) 
  ↓ [用户寄出设备]
shipped (已寄出) 
  ↓ [平台收到设备]
inspected (已检测) 
  ↓ [管理员设置最终价格]
completed (已完成) 
  ↓ [管理员执行打款]
paid (已打款) → 钱存入用户钱包
```

### 2. 打款操作流程

#### 步骤1：打开订单详情
- 在订单列表中找到状态为"已完成"的订单
- 点击"详情"按钮进入订单详情页

#### 步骤2：查看打款信息
- 在订单详情页中，找到"打款信息"部分
- 如果订单状态为"已完成"且有最终价格，会显示"执行打款"按钮
- 显示打款状态、打款方式、打款账户等信息

#### 步骤3：点击打款按钮
- 点击"打款信息"部分的"执行打款"按钮
- 打开打款对话框，显示：
  - 订单号
  - 收款用户
  - 设备信息
  - 打款金额（最终价格 + 加价）
  - 打款方式说明
  - 备注输入框

#### 步骤4：确认打款
- 在打款对话框中点击"确认打款"按钮
- 弹出详细确认对话框，显示：
  - 订单信息（订单号、设备、价格）
  - 打款说明（存入钱包、可提现）
  - 警告提示（无法撤销）
- 在确认对话框中再次点击"确认打款"

#### 步骤5：执行打款
- 系统调用后端API执行打款
- 后端将钱存入用户钱包
- 更新订单打款状态为"已打款"
- 创建钱包交易记录

#### 步骤6：更新显示
- 打款成功后自动刷新订单详情
- 流程进度中的"已打款"步骤更新为已完成状态
- 打款信息部分显示打款详情
- 打款按钮自动隐藏

## 前端实现

### 1. 流程进度显示
- 使用 `el-steps` 组件显示7个步骤
- 根据订单状态和打款状态动态显示步骤状态
- 打款成功后，"已打款"步骤更新为已完成

### 2. 打款按钮
- 位置：在"打款信息"部分的标题栏
- 显示条件：
  - 订单状态为"已完成"或"已检测"
  - 有最终价格
  - 打款状态不是"已打款"
- 点击事件：打开打款对话框

### 3. 打款对话框
- 显示订单信息
- 显示打款金额明细
- 支持填写备注
- 确认按钮触发确认对话框

### 4. 确认对话框
- 显示详细订单信息
- 显示打款说明
- 警告提示
- 确认后执行打款

## 后端实现

### 1. 打款API
- 路径：`POST /admin-api/inspection-orders/:id/payment`
- 功能：
  - 验证订单状态
  - 验证打款条件
  - 计算打款总额
  - 存入用户钱包
  - 更新订单状态
  - 创建交易记录

### 2. 钱包系统
- `Wallet` 模型：用户钱包
- `WalletTransaction` 模型：交易记录
- `add_balance` 方法：增加余额并创建交易记录

### 3. 数据返回
- 订单详情API返回完整的订单信息
- 包含打款状态、打款时间等字段
- 支持前端显示流程进度

## 测试检查清单

- [ ] 订单状态为"已完成"时，打款信息部分显示
- [ ] 打款按钮在"打款信息"部分正确显示
- [ ] 点击打款按钮打开打款对话框
- [ ] 打款对话框显示正确的订单信息
- [ ] 点击确认打款弹出确认对话框
- [ ] 确认对话框中显示详细信息
- [ ] 确认后执行打款操作
- [ ] 打款成功后钱包余额增加
- [ ] 打款成功后流程进度更新
- [ ] 打款成功后打款信息更新
- [ ] 打款成功后打款按钮隐藏

## 常见问题

### 1. 打款按钮不显示
- 检查订单状态是否为"已完成"或"已检测"
- 检查是否有最终价格
- 检查打款状态是否为"已打款"

### 2. 打款失败
- 检查后端日志
- 检查钱包系统是否正常
- 检查数据库连接

### 3. 流程进度不更新
- 检查订单详情是否刷新
- 检查步骤状态判断逻辑
- 检查打款状态是否正确更新






