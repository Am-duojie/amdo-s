# 实验性功能开发指南 - 使用分支保护主代码

## 🎯 为什么需要分支？

### 场景举例

假设你想尝试一个新功能，但不确定能否实现：

**❌ 不用分支（危险）**：
```
main 分支：
  - 提交1: 正常功能
  - 提交2: 尝试新功能（代码可能有问题）
  - 提交3: 新功能失败了，代码混乱
  - 提交4: 想回退，但很麻烦
```

**✅ 使用分支（安全）**：
```
main 分支：
  - 提交1: 正常功能
  - 提交2: 继续正常开发 ✅

experiment/新功能 分支：
  - 提交A: 尝试新功能
  - 提交B: 继续实验
  - 如果成功 → 合并到 main ✅
  - 如果失败 → 直接删除分支，main不受影响 ✅
```

---

## 🚀 实际操作步骤

### 场景：你想实验一个"AI推荐商品"功能

#### 步骤1：创建实验分支

```powershell
# 确保当前代码是干净的（没有未提交的修改）
git status

# 创建并切换到新分支
git checkout -b experiment/ai-recommendation

# 或者使用新语法
git switch -c experiment/ai-recommendation
```

**说明**：
- `experiment/` 是命名约定，表示这是实验性功能
- `ai-recommendation` 是功能名称
- `-b` 表示创建新分支
- `-c` 也表示创建新分支（新语法）

#### 步骤2：在实验分支上开发

```powershell
# 现在你在 experiment/ai-recommendation 分支上
# 可以随意修改代码，不会影响 main 分支

# 编辑代码...
# 比如：添加 AI 推荐相关的文件

# 提交实验代码
git add .
git commit -m "实验：添加AI推荐功能基础代码"

# 继续实验...
git add .
git commit -m "实验：尝试不同的推荐算法"

# 可以提交多次，不用担心影响主代码
```

#### 步骤3A：实验成功，合并到主分支

```powershell
# 1. 切换回主分支
git checkout main
# 或
git switch main

# 2. 确保主分支是最新的
git pull origin main

# 3. 合并实验分支
git merge experiment/ai-recommendation

# 4. 推送到GitHub
git push origin main

# 5. 删除实验分支（可选，但建议）
git branch -d experiment/ai-recommendation
```

#### 步骤3B：实验失败，放弃实验

```powershell
# 1. 切换回主分支
git checkout main
# 或
git switch main

# 2. 删除实验分支（放弃所有实验代码）
git branch -D experiment/ai-recommendation
# 注意：-D 是强制删除，即使有未合并的提交

# 3. 主分支完全不受影响，继续正常开发
```

---

## 📊 可视化流程

### 实验成功的流程

```
main 分支（稳定）
  ├─ 提交1: 正常功能
  ├─ 提交2: 正常功能
  │
  └─ 创建分支 experiment/ai-recommendation
      │
      ├─ 提交A: 实验代码1
      ├─ 提交B: 实验代码2
      └─ 提交C: 实验成功 ✅
          │
          └─ 合并回 main
              │
              └─ main 分支：
                  ├─ 提交1: 正常功能
                  ├─ 提交2: 正常功能
                  └─ 提交3: 合并AI推荐功能 ✅
```

### 实验失败的流程

```
main 分支（稳定）
  ├─ 提交1: 正常功能
  ├─ 提交2: 正常功能
  │
  └─ 创建分支 experiment/ai-recommendation
      │
      ├─ 提交A: 实验代码1
      ├─ 提交B: 实验代码2
      └─ 提交C: 实验失败 ❌
          │
          └─ 删除分支
              │
              └─ main 分支：
                  ├─ 提交1: 正常功能
                  └─ 提交2: 正常功能
                  （完全不受影响）✅
```

---

## 🎨 实际例子

### 例子1：实验新的支付方式

```powershell
# 1. 创建实验分支
git checkout -b experiment/wechat-pay

# 2. 在分支上开发
# 编辑支付相关代码...
git add backend/payment/wechat_pay.py
git commit -m "实验：添加微信支付接口"

# 3. 测试后发现微信支付API有问题，决定放弃
git checkout main
git branch -D experiment/wechat-pay

# 4. main 分支完全不受影响，继续用支付宝支付
```

### 例子2：实验新的UI设计

```powershell
# 1. 创建实验分支
git checkout -b experiment/new-ui

# 2. 在分支上尝试新设计
# 修改前端样式...
git add frontend/src/
git commit -m "实验：新的UI设计"

# 3. 测试后觉得不错，决定采用
git checkout main
git merge experiment/new-ui
git push origin main

# 4. 删除实验分支
git branch -d experiment/new-ui
```

### 例子3：尝试不同的技术方案

```powershell
# 1. 创建实验分支
git checkout -b experiment/redis-cache

# 2. 尝试用Redis做缓存
git add backend/cache/redis_cache.py
git commit -m "实验：使用Redis缓存"

# 3. 发现性能提升不明显，决定用内存缓存
git checkout main
git branch -D experiment/redis-cache

# 4. 继续在main分支用内存缓存方案
```

---

## 🔍 查看和管理分支

### 查看所有分支

```powershell
# 查看本地分支
git branch

# 输出：
# * main                          ← 当前分支（*标记）
#   experiment/ai-recommendation

# 查看所有分支（包括远程）
git branch -a

# 查看分支的提交历史
git log --oneline --graph --all
```

### 切换分支

```powershell
# 切换到main分支
git checkout main
# 或
git switch main

# 切换到实验分支
git checkout experiment/ai-recommendation
# 或
git switch experiment/ai-recommendation
```

### 查看当前在哪个分支

```powershell
git branch
# * 标记的就是当前分支

# 或
git status
# 第一行会显示当前分支
```

---

## ⚠️ 重要注意事项

### 1. 切换分支前确保代码已提交

```powershell
# ❌ 错误：有未提交的修改就切换分支
git checkout experiment/new-feature
# 错误：会提示有未提交的修改

# ✅ 正确：先提交或暂存
git add .
git commit -m "保存当前工作"
git checkout experiment/new-feature
```

### 2. 合并前确保主分支是最新的

```powershell
# ✅ 合并前先更新主分支
git checkout main
git pull origin main
git merge experiment/new-feature
```

### 3. 分支命名规范

```
✅ 好的命名：
- experiment/ai-recommendation  （实验性功能）
- feature/user-profile          （新功能）
- bugfix/payment-error          （修复bug）
- test/new-api                  （测试）

❌ 不好的命名：
- branch1
- new
- test
```

---

## 🎯 适合你项目的场景

### 场景1：想尝试新的前端框架

```powershell
# 当前用Vue，想试试React
git checkout -b experiment/react-migration

# 尝试用React重写某个页面
# 如果效果好 → 合并
# 如果不好 → 删除分支，继续用Vue
```

### 场景2：想优化数据库查询

```powershell
# 想尝试新的数据库优化方案
git checkout -b experiment/db-optimization

# 尝试不同的查询方式
# 测试性能
# 决定是否采用
```

### 场景3：想添加新功能但不确定

```powershell
# 想添加"商品比价"功能，但不确定能否实现
git checkout -b experiment/price-comparison

# 尝试开发
# 如果API可用 → 继续开发并合并
# 如果API不可用 → 删除分支
```

---

## 📝 完整工作流程示例

### 场景：实验"智能推荐"功能

```powershell
# ===== 第1天：开始实验 =====

# 1. 确保main分支是干净的
git checkout main
git status

# 2. 创建实验分支
git checkout -b experiment/smart-recommendation

# 3. 开始实验
# 编辑代码...
git add backend/recommendation/
git commit -m "实验：添加推荐算法基础代码"

# ===== 第2天：继续实验 =====

# 继续在实验分支工作
git checkout experiment/smart-recommendation
# 编辑代码...
git add .
git commit -m "实验：优化推荐算法"

# ===== 第3天：决定采用 =====

# 1. 切换回主分支
git checkout main

# 2. 更新主分支（如果有其他人的提交）
git pull origin main

# 3. 合并实验分支
git merge experiment/smart-recommendation

# 4. 解决可能的冲突（如果有）
# 编辑冲突文件...
git add .
git commit -m "解决合并冲突"

# 5. 推送到GitHub
git push origin main

# 6. 删除实验分支
git branch -d experiment/smart-recommendation

# 完成！✅
```

### 场景：实验失败，放弃

```powershell
# ===== 实验过程 =====

git checkout -b experiment/new-feature
# 开发...
git commit -m "实验代码"

# ===== 决定放弃 =====

# 1. 切换回主分支
git checkout main

# 2. 删除实验分支（放弃所有实验代码）
git branch -D experiment/new-feature

# 3. 主分支完全不受影响，继续正常开发
# 完成！✅
```

---

## 🎁 快速参考命令

### 创建和切换分支

```powershell
# 创建并切换到新分支
git checkout -b experiment/功能名
# 或
git switch -c experiment/功能名

# 切换到已有分支
git checkout main
# 或
git switch main
```

### 查看分支

```powershell
# 查看本地分支
git branch

# 查看所有分支
git branch -a

# 查看分支历史
git log --oneline --graph --all
```

### 合并分支

```powershell
# 切换到主分支
git checkout main

# 合并实验分支
git merge experiment/功能名

# 推送到GitHub
git push origin main
```

### 删除分支

```powershell
# 删除已合并的分支
git branch -d experiment/功能名

# 强制删除未合并的分支（放弃实验）
git branch -D experiment/功能名
```

---

## 💡 最佳实践

### ✅ 应该做的

1. **实验前创建分支**
   - 不确定的功能都在分支上实验

2. **分支命名清晰**
   - `experiment/功能名` 或 `feature/功能名`

3. **实验成功后合并**
   - 测试通过后再合并到主分支

4. **实验失败就删除**
   - 不要保留无用的实验分支

### ❌ 不应该做的

1. **在主分支直接实验**
   - 可能破坏稳定代码

2. **保留无用的分支**
   - 定期清理实验分支

3. **不测试就合并**
   - 合并前要测试功能

---

## 🎯 总结

### 实验性功能的开发流程

```
1. 创建实验分支
   git checkout -b experiment/功能名

2. 在分支上开发
   （可以随意修改，不影响主代码）

3. 决定结果：
   - 成功 → 合并到主分支
   - 失败 → 删除分支
```

### 核心优势

- ✅ **主代码安全**：实验不会影响稳定代码
- ✅ **可以放弃**：实验失败直接删除，不留痕迹
- ✅ **可以对比**：可以随时切换查看不同版本
- ✅ **灵活开发**：可以同时进行多个实验

**现在你可以放心地尝试新功能了！** 🚀


