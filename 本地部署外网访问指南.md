# 本地部署外网访问完整指南

## 📋 目录
1. [方案概述](#方案概述)
2. [准备生产环境配置](#准备生产环境配置)
3. [方案一：内网穿透（推荐）](#方案一内网穿透推荐)
4. [方案二：路由器端口转发](#方案二路由器端口转发)
5. [方案三：使用云服务器](#方案三使用云服务器)
6. [生产环境部署步骤](#生产环境部署步骤)
7. [常见问题解决](#常见问题解决)

---

## 🎯 方案概述

要让本地部署的项目能被外网访问，有以下几种方案：

| 方案 | 优点 | 缺点 | 推荐度 |
|------|------|------|--------|
| **内网穿透** | 简单快速，无需配置路由器 | 免费版可能不稳定，有带宽限制 | ⭐⭐⭐⭐⭐ |
| **端口转发** | 稳定，速度快 | 需要公网IP，配置复杂 | ⭐⭐⭐ |
| **云服务器** | 最稳定，专业 | 需要付费，配置复杂 | ⭐⭐⭐⭐ |

**个人开发推荐：使用内网穿透（方案一）**

---

## 🔧 准备生产环境配置

### 1. 创建生产环境配置文件

首先需要修改 Django 配置，让项目适合生产环境。

#### 创建 `backend/core/settings_production.py`

这是生产环境的配置文件，从开发配置继承并覆盖关键设置。

```python
from .settings import *
import os

# 安全设置
DEBUG = False  # 关闭调试模式
SECRET_KEY = os.environ.get('SECRET_KEY', SECRET_KEY)  # 从环境变量读取密钥

# 允许的主机（必须配置你的域名或IP）
ALLOWED_HOSTS = [
    'localhost',
    '127.0.0.1',
    '你的域名.com',  # 替换为你的域名或内网穿透域名
    '*.ngrok.io',    # ngrok域名
    '*.natapp.cc',   # natapp域名
    '*.frp.com',     # frp域名（根据你的服务商）
]

# 数据库配置（生产环境建议使用更强的密码）
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': os.environ.get('DB_NAME', 'secondhand_platform'),
        'USER': os.environ.get('DB_USER', 'root'),
        'PASSWORD': os.environ.get('DB_PASSWORD', '你的数据库密码'),
        'HOST': os.environ.get('DB_HOST', '127.0.0.1'),
        'PORT': os.environ.get('DB_PORT', '3306'),
        'OPTIONS': {
            'charset': 'utf8mb4',
        },
    }
}

# CORS 配置 - 添加你的前端域名
CORS_ALLOWED_ORIGINS = [
    "http://localhost:5173",
    "http://127.0.0.1:5173",
    # 添加你的外网访问地址
    "https://你的前端域名",
]

# 或者允许所有来源（开发测试用，生产环境不推荐）
# CORS_ALLOW_ALL_ORIGINS = True  # 仅在测试时使用

# 静态文件和媒体文件
STATIC_ROOT = os.path.join(BASE_DIR, 'static')
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')

# 支付回调地址（必须改为你的公网地址）
EASYPAY_NOTIFY_URL = 'https://你的域名/api/payment/notify/'
EASYPAY_RETURN_URL = 'https://你的域名/order/'

# Redis 配置（如果需要）
CHANNEL_LAYERS = {
    "default": {
        "BACKEND": "channels_redis.core.RedisChannelLayer",
        "CONFIG": {
            "hosts": [("127.0.0.1", 6379)],
        },
    },
}

# 日志配置（生产环境建议启用）
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'handlers': {
        'file': {
            'level': 'INFO',
            'class': 'logging.FileHandler',
            'filename': os.path.join(BASE_DIR, 'logs', 'django.log'),
        },
    },
    'loggers': {
        'django': {
            'handlers': ['file'],
            'level': 'INFO',
            'propagate': True,
        },
    },
}
```

---

## 🌐 方案一：内网穿透（推荐）

内网穿透是最简单的方式，适合个人开发和测试。

### 选项 1：Ngrok（最简单，推荐新手）

#### 注册和安装
1. **注册账号**：
   - 访问：https://ngrok.com/
   - 注册免费账号
   - 获取 authtoken

2. **下载安装**：
   - Windows: 下载 ngrok.exe
   - 放到项目目录或添加到系统 PATH

3. **配置 authtoken**：
   ```bash
   ngrok config add-authtoken 你的authtoken
   ```

#### 使用方法

**启动后端服务**：
```bash
cd backend
python manage.py runserver 0.0.0.0:8000
```

**新开终端，启动 ngrok**：
```bash
# 映射后端端口（8000）
ngrok http 8000
```

**启动前端服务**（如果也在本地）：
```bash
cd frontend
npm run dev
```

**新开终端，映射前端端口（5173）**：
```bash
ngrok http 5173
```

#### 配置项目使用 ngrok 域名

Ngrok 启动后会给你两个地址：
- `http://xxxx.ngrok-free.app` - HTTP地址
- `https://xxxx.ngrok-free.app` - HTTPS地址（推荐使用）

**修改前端配置**：

创建 `frontend/.env.production`：
```env
VITE_API_URL=https://xxxx.ngrok-free.app/api
```

**修改后端 CORS 配置**：

在 `settings.py` 或 `settings_production.py` 中添加：
```python
CORS_ALLOWED_ORIGINS = [
    "https://你的前端ngrok域名.ngrok-free.app",
]

ALLOWED_HOSTS = [
    '你的后端ngrok域名.ngrok-free.app',
]
```

**修改支付回调地址**：
```python
EASYPAY_NOTIFY_URL = 'https://你的后端ngrok域名.ngrok-free.app/api/payment/notify/'
EASYPAY_RETURN_URL = 'https://你的前端ngrok域名.ngrok-free.app/order/'
```

#### Ngrok 免费版限制
- 域名每次启动会变化（付费版可以固定）
- 有并发连接数限制
- 适合开发和测试使用

---

### 选项 2：Natapp（国内推荐，速度快）

#### 注册和配置
1. **注册账号**：
   - 访问：https://natapp.cn/
   - 注册账号

2. **购买隧道**（免费版有限制）：
   - 登录后创建隧道
   - 本地端口填写：8000（后端）
   - 协议选择：http

3. **下载客户端**：
   - 下载 Windows 版本
   - 解压到项目目录

#### 使用方法

**配置 config.ini**：
```ini
[default]
authtoken=你的authtoken
```

**启动 natapp**：
```bash
# 启动后端隧道
natapp -authtoken=你的authtoken -subdomain=你的子域名 8000

# 或者使用配置文件
natapp -config=config.ini
```

#### 配置项目
和 ngrok 类似，将域名替换为 natapp 给你的地址即可。

---

### 选项 3：FRP（开源，需要服务器）

如果你有自己的服务器，可以使用 FRP 搭建内网穿透。

#### 服务器端配置（frps.ini）
```ini
[common]
bind_port = 7000
token = 你的token
```

#### 客户端配置（frpc.ini）
```ini
[common]
server_addr = 你的服务器IP
server_port = 7000
token = 你的token

[web_backend]
type = http
local_port = 8000
custom_domains = 你的域名.com

[web_frontend]
type = http
local_port = 5173
custom_domains = 你的域名.com
```

---

## 📡 方案二：路由器端口转发

如果你有公网 IP，可以配置路由器端口转发。

### 前提条件
- 拥有公网 IP（不是运营商的内网IP）
- 可以访问路由器管理界面
- 知道如何配置端口转发

### 配置步骤

1. **查看本机内网 IP**：
   ```bash
   # Windows
   ipconfig
   
   # 查看 IPv4 地址，例如：192.168.1.100
   ```

2. **配置路由器端口转发**：
   - 登录路由器管理界面（通常是 192.168.1.1）
   - 找到"端口转发"或"虚拟服务器"功能
   - 添加规则：
     - 外部端口：8000 → 内网IP：192.168.1.100，内网端口：8000
     - 外部端口：5173 → 内网IP：192.168.1.100，内网端口：5173

3. **查看公网 IP**：
   - 访问：https://www.ipip.net/
   - 查看你的公网 IP

4. **配置防火墙**：
   - Windows 防火墙允许 8000 和 5173 端口
   - 或者关闭防火墙（仅测试时）

5. **访问项目**：
   - 前端：`http://你的公网IP:5173`
   - 后端：`http://你的公网IP:8000`

---

## ☁️ 方案三：使用云服务器

如果预算允许，使用云服务器是最稳定的方案。

### 推荐云服务器

- **阿里云**：https://www.aliyun.com/
- **腾讯云**：https://cloud.tencent.com/
- **华为云**：https://www.huaweicloud.com/
- **Vultr**：https://www.vultr.com/（国外）

### 部署步骤
1. 购买云服务器（建议 2核4G 起步）
2. 配置安全组（开放 80、443、8000 端口）
3. 远程连接服务器
4. 安装环境（Python、Node.js、MySQL、Redis、Nginx）
5. 上传项目代码
6. 配置域名解析
7. 使用 Nginx 反向代理

---

## 🚀 生产环境部署步骤

### 1. 修改配置使用生产环境设置

**方式一：使用环境变量切换**
```bash
# Windows PowerShell
$env:DJANGO_SETTINGS_MODULE="core.settings_production"
python manage.py runserver 0.0.0.0:8000
```

**方式二：直接修改 settings.py**
将 `DEBUG = True` 改为 `DEBUG = False`，并更新 `ALLOWED_HOSTS`。

### 2. 收集静态文件
```bash
cd backend
python manage.py collectstatic --noinput
```

### 3. 启动后端服务

**使用开发服务器**（仅测试用）：
```bash
python manage.py runserver 0.0.0.0:8000
```

**使用 Gunicorn**（推荐生产环境）：
```bash
# 安装 Gunicorn
pip install gunicorn

# 启动服务
gunicorn core.wsgi:application --bind 0.0.0.0:8000 --workers 4
```

**使用 Daphne**（如果使用 WebSocket）：
```bash
# 安装 Daphne
pip install daphne

# 启动服务（支持 WebSocket）
daphne -b 0.0.0.0 -p 8000 core.asgi:application
```

### 4. 构建前端项目
```bash
cd frontend

# 创建生产环境配置文件
echo "VITE_API_URL=https://你的后端地址/api" > .env.production

# 构建
npm run build
```

构建完成后，`frontend/dist` 目录就是生产环境的前端文件。

### 5. 使用 Nginx 部署前端（可选）

如果有云服务器，可以使用 Nginx 部署前端：

**nginx.conf 示例**：
```nginx
server {
    listen 80;
    server_name 你的域名.com;

    root /path/to/frontend/dist;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 6. 启动内网穿透

根据你选择的内网穿透方案启动：
- Ngrok: `ngrok http 8000`
- Natapp: `natapp -authtoken=xxx 8000`
- FRP: `frpc -c frpc.ini`

---

## 🔒 安全配置建议

### 1. 修改 SECRET_KEY
```python
# 生成新的密钥
# Python
from django.core.management.utils import get_random_secret_key
print(get_random_secret_key())

# 或使用环境变量
import os
SECRET_KEY = os.environ.get('SECRET_KEY', '默认密钥')
```

### 2. 使用环境变量管理敏感信息
创建 `.env` 文件（不要提交到 Git）：
```env
SECRET_KEY=你的密钥
DB_PASSWORD=数据库密码
EASYPAY_PID=支付商户ID
EASYPAY_KEY=支付密钥
```

安装 python-decouple 读取环境变量：
```bash
pip install python-decouple
```

### 3. 配置 HTTPS（如果有域名）
使用 Let's Encrypt 免费 SSL 证书：
```bash
# 安装 certbot
certbot --nginx -d 你的域名.com
```

---

## 📝 完整部署脚本

### Windows 启动脚本

创建 `start_production.bat`：
```batch
@echo off
echo 正在启动生产环境服务...

REM 激活虚拟环境
call backend\venv\Scripts\activate.bat

REM 切换到后端目录
cd backend

REM 设置环境变量
set DJANGO_SETTINGS_MODULE=core.settings_production

REM 收集静态文件
python manage.py collectstatic --noinput

REM 启动后端服务（使用 Daphne 支持 WebSocket）
start "后端服务" daphne -b 0.0.0.0 -p 8000 core.asgi:application

echo 后端服务已启动在 0.0.0.0:8000
echo 请在新终端启动内网穿透工具
pause
```

创建 `start_ngrok.bat`：
```batch
@echo off
echo 正在启动 Ngrok 内网穿透...

REM 启动 ngrok 映射 8000 端口
ngrok http 8000

pause
```

---

## 🔍 常见问题解决

### 1. CORS 跨域错误

**问题**：前端访问后端 API 时出现 CORS 错误。

**解决**：
- 检查 `CORS_ALLOWED_ORIGINS` 是否包含前端地址
- 确保使用完整的 URL（包括协议 http/https）
- 临时测试可以使用 `CORS_ALLOW_ALL_ORIGINS = True`

### 2. 静态文件 404

**问题**：静态文件（CSS、JS）无法加载。

**解决**：
```bash
# 收集静态文件
python manage.py collectstatic --noinput

# 检查 STATIC_ROOT 配置
# 确保 Nginx 或开发服务器正确配置静态文件路径
```

### 3. WebSocket 连接失败

**问题**：WebSocket 无法连接。

**解决**：
- 确保使用 Daphne 或支持 ASGI 的服务器
- 检查 Redis 是否运行
- 内网穿透工具需要支持 WebSocket（ngrok 免费版支持）

### 4. 数据库连接失败

**问题**：无法连接 MySQL。

**解决**：
- 检查 MySQL 服务是否运行
- 验证数据库用户名密码
- 检查防火墙是否阻止连接
- 确保数据库允许远程连接（如果不在本地）

### 5. 支付回调失败

**问题**：支付后无法收到回调。

**解决**：
- 确保回调地址是公网可访问的 HTTPS 地址
- 检查 `EASYPAY_NOTIFY_URL` 配置
- 查看服务器日志确认是否收到回调请求

### 6. Ngrok 域名每次变化

**问题**：免费版 ngrok 域名每次启动都变化。

**解决**：
- 购买 ngrok 付费版可以固定域名
- 或使用 natapp 免费版（部分提供固定域名）
- 或使用 FRP 自建服务

---

## 🎯 推荐部署流程

### 快速开始（个人开发测试）

1. **使用 Ngrok 内网穿透**（最简单）
   ```bash
   # 1. 启动后端
   cd backend
   python manage.py runserver 0.0.0.0:8000
   
   # 2. 新终端启动 ngrok
   ngrok http 8000
   
   # 3. 复制 ngrok 给的 HTTPS 地址
   # 4. 修改前端 .env 文件中的 API 地址
   # 5. 启动前端并构建
   ```

2. **修改配置文件**
   - 更新 `ALLOWED_HOSTS`
   - 更新 `CORS_ALLOWED_ORIGINS`
   - 更新支付回调地址

3. **测试访问**
   - 使用手机连接其他网络测试
   - 或让朋友帮忙测试外网访问

---

## 📚 相关资源

- **Ngrok 官网**：https://ngrok.com/
- **Natapp 官网**：https://natapp.cn/
- **FRP 项目**：https://github.com/fatedier/frp
- **Django 部署文档**：https://docs.djangoproject.com/en/stable/howto/deployment/
- **Vite 构建文档**：https://vitejs.dev/guide/build.html

---

## 💡 总结

对于**个人开发**，推荐使用：

1. **内网穿透（Ngrok 或 Natapp）** - 最简单快速
2. **本地开发服务器** - 快速迭代
3. **生产环境配置** - 测试生产环境设置

关键步骤：
1. ✅ 修改配置为生产环境
2. ✅ 启动后端服务
3. ✅ 启动内网穿透工具
4. ✅ 配置前端使用新的 API 地址
5. ✅ 测试外网访问

记住：内网穿透工具运行时，你的服务才能被外网访问。关闭工具后，外网就无法访问了。

祝部署顺利！🚀




