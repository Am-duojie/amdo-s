# 回收业务完整流程

## 业务流程状态流转图

```
用户提交订单 (pending)
    ↓
用户寄出设备 (shipped)
    ↓
平台收到设备 (received) - 内部状态
    ↓
质检检测 (inspected)
    ↓
确定最终价格 (price_confirmed) - 内部状态
    ↓
用户确认最终价格 (final_price_confirmed) 或这用户不认可选择退货
    ↓
订单完成 (completed)
    ↓
平台打款 (paid)
    ↓ (可选)
发布为官方验商品 (published)
```

## 详细业务流程说明

### 1. 用户提交订单 (pending)
- **操作者**: 用户
- **输入**: 设备类型、品牌、型号、存储、成色、联系方式、收货地址
- **系统行为**: 创建订单，状态设为 `pending`
- **下一步**: 自动估价或等待管理员估价

### 2. 估价阶段 (quoted)
- **操作者**: 系统自动估价 或 管理员手动估价
- **输入**: 预估价格
- **系统行为**: 
  - 系统根据设备信息自动估价
  - 或管理员审核后给出预估价格
  - 状态更新为 `quoted`
- **通知**: 通知用户估价结果
- **下一步**: 用户确认或提出异议

### 3. 用户确认 (confirmed)
- **操作者**: 用户
- **操作**: 
  - 确认估价：填写详细的收货地址，确认订单
  - 或提出价格异议：填写异议原因
- **系统行为**: 
  - 确认：状态更新为 `confirmed`，生成回收地址和物流信息
  - 异议：状态仍为 `quoted`，标记 `price_dispute=True`，等待管理员重新估价
- **下一步**: 
  - 确认：用户寄出设备
  - 异议：管理员重新估价

### 4. 用户寄出设备 (shipped)
- **操作者**: 用户
- **输入**: 物流公司、运单号
- **系统行为**: 
  - 更新物流信息
  - 状态更新为 `shipped`
  - 记录寄出时间 `shipped_at`
- **通知**: 通知平台有设备寄出
- **下一步**: 平台收到设备

### 5. 平台收到设备 (received) - 管理员操作
- **操作者**: 管理员
- **操作**: 确认收到设备
- **系统行为**: 
  - 状态仍为 `shipped`（内部标记为已收到）
  - 记录收到时间 `received_at`
- **下一步**: 进行质检

### 6. 质检检测 (inspected)
- **操作者**: 管理员/质检员
- **输入**: 
  - 质检报告（检测项目JSON）
  - 质检备注
  - 根据质检结果调整最终价格
- **系统行为**: 
  - 创建质检报告
  - 状态更新为 `inspected`
  - 记录质检时间 `inspected_at`
  - 设置最终价格 `final_price`
- **通知**: 通知用户质检完成，展示最终价格
- **下一步**: 用户确认最终价格（如果有异议可提出）或直接完成订单

### 7. 用户确认最终价格 (可选流程)
- **操作者**: 用户
- **操作**: 
  - 确认最终价格：同意价格，等待完成订单
  - 提出价格异议：填写异议原因
- **系统行为**: 
  - 确认：标记价格已确认
  - 异议：标记 `price_dispute=True`，等待管理员协商或调整价格
- **下一步**: 订单完成

### 8. 订单完成 (completed)
- **操作者**: 系统或管理员
- **条件**: 
  - 最终价格已确定
  - 用户已确认最终价格（如果有异议流程）
- **系统行为**: 
  - 状态更新为 `completed`
  - 计算最终应付款项 = `final_price + bonus`
- **下一步**: 平台打款

### 9. 平台打款 (paid)
- **操作者**: 管理员
- **输入**: 
  - 打款方式（银行转账、支付宝、微信等）
  - 打款账户（用户提供的收款账户）
  - 打款备注
- **系统行为**: 
  - 记录打款信息
  - 打款状态更新为 `paid`
  - 记录打款时间 `paid_at`
  - 可以调用第三方支付接口完成打款
- **通知**: 通知用户打款完成
- **下一步**: （可选）发布为官方验商品

### 10. 发布为官方验商品 (published) - 可选
- **操作者**: 管理员
- **条件**: 
  - 订单已完成
  - 设备成色良好，符合官方验标准
- **系统行为**: 
  - 创建 `VerifiedProduct` 对象
  - 设置商品价格（通常为回收价的1.3-1.5倍）
  - 使用质检报告作为商品描述
  - 标记商品来源为回收订单
- **结果**: 商品上架到官方验货区

## 异常流程

### 价格异议流程
1. 用户对估价有异议 → 标记 `price_dispute=True`，填写异议原因
2. 管理员重新评估 → 调整预估价格或最终价格
3. 用户再次确认 → 如果接受，继续流程；如果仍不接受，可取消订单

### 订单取消流程
1. **用户主动取消** (cancelled):
   - 在订单确认前（`pending` 或 `quoted` 状态）可以取消
   - 记录取消原因
   
2. **平台拒绝** (cancelled):
   - 质检发现设备与描述不符
   - 设备存在严重问题
   - 记录拒绝原因 `reject_reason`

### 打款失败处理
1. 打款失败 → `payment_status='failed'`
2. 记录失败原因
3. 管理员重新尝试打款或联系用户更新账户信息

## 状态列表

- `pending`: 待估价 - 用户已提交订单，等待估价
- `quoted`: 已估价 - 已给出预估价格，等待用户确认
- `confirmed`: 已确认 - 用户确认估价，填写了收货地址，等待寄出
- `shipped`: 已寄出 - 用户已填写物流信息并寄出设备
- `inspected`: 已检测 - 平台已完成质检，已确定最终价格
- `completed`: 已完成 - 订单流程完成，等待打款
- `paid`: 已打款 - 平台已完成打款（可选状态，也可在completed中通过payment_status区分）
- `cancelled`: 已取消 - 订单被取消或拒绝

## 关键时间节点

- `created_at`: 订单创建时间
- `shipped_at`: 用户寄出时间
- `received_at`: 平台收到时间
- `inspected_at`: 质检完成时间
- `paid_at`: 打款时间

## 权限要求

- `inspection:view`: 查看订单
- `inspection:write`: 估价、质检、更新状态
- `inspection:price`: 更新价格
- `inspection:payment`: 执行打款操作
- `recycled:write`: 发布为官方验商品


