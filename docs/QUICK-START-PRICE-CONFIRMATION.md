# 回收订单价格确认功能 - 快速开始

## 功能概述

回收订单新增了价格确认环节：管理员完成质检并设置最终价格后，用户需要确认价格，订单才会进入打款阶段。

## 使用流程

### 用户操作

1. **完成估价问卷**
   - 在回收估价页面填写设备信息
   - 选择品牌、型号、存储容量、成色等
   - 系统自动计算预估价格

2. **查看估价详情**
   - 自动跳转到估价详情页
   - 查看预估价格和价格明细
   - 查看平台收件地址
   - 确认收款信息

3. **提交订单**
   - 点击"提交订单"按钮
   - 确认提交
   - 订单创建成功，状态为"待寄出"
   - 自动跳转到订单详情页

4. **填写物流信息**
   - 在订单详情页点击"填写物流信息"按钮
   - 选择物流公司并填写运单号
   - 提交后订单状态自动变为"已寄出"

5. **寄出设备**
   - 按照填写的物流信息寄出设备
   - 等待平台收货和质检

6. **确认价格**
   - 质检完成后，订单状态变为"已检测"
   - 查看质检报告和最终价格
   - 查看价格明细（最终价格 + 加价 = 实付金额）
   - 点击"确认最终价格"按钮
   - 在弹窗中再次确认金额
   - 点击"确认"

7. **等待打款**
   - 确认后订单状态变为"已完成"
   - 等待管理员打款
   - 打款完成后可在钱包中查看余额

### 管理员操作

1. **收货并质检**
   - 在管理后台找到已寄出的订单
   - 点击"确认收到设备"，订单状态变为"已收货"
   - 点击"开始质检"，填写66项质检报告
   - 设置最终价格和加价（如有）
   - 保存质检报告，订单状态变为"已检测"

2. **等待用户确认**
   - 质检完成后，管理后台会显示黄色提示框："等待用户确认最终价格"
   - 此时无法直接完成订单或打款

3. **用户确认后打款**
   - 用户确认价格后，订单自动变为"已完成"
   - 点击"打款给用户"按钮
   - 选择打款方式（支付宝转账/钱包）
   - 完成打款

### 价格异议处理

如果用户对价格不满意：

1. **用户提出异议**
   - 点击"对最终价格有异议"按钮
   - 填写异议原因
   - 提交异议

2. **管理员处理**
   - 订单保持"已检测"状态
   - 查看用户异议原因
   - 重新评估并调整价格
   - 保存新的最终价格

3. **用户重新确认**
   - 查看调整后的价格
   - 确认或继续提出异议

## 状态说明

| 状态 | 说明 | 下一步操作 | 页面显示 |
|------|------|-----------|---------|
| pending | 待寄出 | **用户填写物流信息** | "订单已提交，请填写物流信息并寄出设备" |
| shipped | 已寄出 | 管理员确认收货 | "设备已寄出，等待平台收货" |
| received | 已收货 | 管理员质检 | "平台已收货，等待质检中" |
| inspected | 已检测 | **用户确认价格** | "质检已完成，请确认最终价格" |
| completed | 已完成 | 管理员打款 | "订单已完成，等待平台打款中..." |

## API 端点

### 用户确认价格
```
POST /api/recycle-orders/{id}/confirm_final_price/
```

**响应示例**:
```json
{
  "success": true,
  "message": "价格确认成功，订单已进入打款阶段",
  "order": {
    "id": 123,
    "status": "completed",
    "final_price_confirmed": true,
    "final_price": "1000.00",
    "bonus": "50.00"
  }
}
```

## 界面截图说明

### 管理端 - 等待用户确认
- 黄色警告框显示："等待用户确认最终价格 ¥1000"
- 提示："用户确认价格后，订单将自动进入打款阶段"

### 用户端 - 确认价格
- 蓝色信息框显示："质检已完成，请确认最终价格"
- 显示最终价格和加价金额
- 两个按钮："确认最终价格" 和 "对最终价格有异议"

### 用户端 - 已确认
- 绿色成功框显示："您已确认最终价格，订单正在进入打款阶段..."

## 常见问题

### Q: 用户不确认价格怎么办？
A: 订单会一直保持"已检测"状态，管理员可以联系用户催促确认，或者用户可以提出价格异议。

### Q: 管理员可以代替用户确认吗？
A: 不可以。这是为了保护用户权益，确保用户知晓并同意最终价格。

### Q: 用户确认后可以反悔吗？
A: 确认后无法撤销。如果用户有问题，需要联系客服处理。

### Q: 旧订单会受影响吗？
A: 不会。旧订单的 `final_price_confirmed` 默认为 `false`，但不影响已完成的订单。

### Q: 价格异议后如何处理？
A: 管理员可以重新评估并调整价格，用户需要重新确认新的价格。

## 技术细节

### 数据库字段
- `final_price_confirmed`: 布尔值，默认 `false`
- 已存在于 RecycleOrder 模型中

### 状态流转
```python
# 用户确认价格
order.final_price_confirmed = True
order.status = 'completed'
order.save()
```

### 权限要求
- 用户端：需要登录，且订单属于当前用户
- 管理端：需要 `inspection:view` 权限查看，`inspection:write` 权限操作

## 相关文档

- [详细技术文档](./40-dev-guide/recycle-order-price-confirmation.md)
- [质检报告数据格式](./40-dev-guide/inspection-report-data-format.md)
- [管理端质检报告编辑器](./40-dev-guide/admin-inspection-report-editor.md)
