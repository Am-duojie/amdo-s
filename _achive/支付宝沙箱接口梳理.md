# 支付宝沙箱接口梳理

## 接口总览
- 创建支付：`POST /api/payment/create/`（普通/验货订单）
  - 入口：`backend/core/urls.py:47` → `backend/app/secondhand_app/payment_views.py:19-101`
  - 主要参数：`order_id`、`order_type`
  - 构造 `notify_url`：`backend/app/secondhand_app/payment_views.py:72`
  - 构造 `return_url`：`backend/app/secondhand_app/payment_views.py:74-77`
  - 调用支付宝：`alipay.trade.page.pay` → `backend/app/secondhand_app/alipay_client.py:258-306`

- 生成支付URL代理：`POST /api/payment/create-url/`
  - 入口：`backend/core/urls.py:48` → `backend/app/secondhand_app/payment_views.py:104-112`
  - 内部复用 `create_payment`

- 异步通知：`GET|POST /api/payment/alipay/notify/`
  - 入口：`backend/core/urls.py:50` → `backend/app/secondhand_app/payment_views.py:114-181`
  - 参数来源：支付宝标准通知参数（含 `out_trade_no`、`trade_status`、`trade_no`、`sign` 等）`backend/app/secondhand_app/payment_views.py:122-137`
  - 验签：`AlipayClient.verify_notify` → `_verify_sign`（RSA2）`backend/app/secondhand_app/alipay_client.py:176-223`
  - 订单状态更新：`backend/app/secondhand_app/payment_views.py:151-171`
  - 响应：返回 `success` `backend/app/secondhand_app/payment_views.py:180-181`

- 同步查询：`GET /api/payment/query/<order_id>/`
  - 入口：`backend/core/urls.py:49` → `backend/app/secondhand_app/payment_views.py:184-231`
  - 调用支付宝：`alipay.trade.query` `backend/app/secondhand_app/alipay_client.py:329-347`
  - 补写状态：`backend/app/secondhand_app/payment_views.py:216-219`

- 钱包提现到支付宝账户：`POST /api/users/withdraw/`
  - 入口：`backend/app/secondhand_app/views.py:143-257`
  - 参数：`amount`、`alipay_account`、`alipay_name`
  - 调用支付宝：`alipay.fund.trans.uni.transfer` `backend/app/secondhand_app/alipay_client.py:432-463`
  - 结果处理：`backend/app/secondhand_app/views.py:206-243`

- 管理后台分账重试：`POST /admin-api/payment/order/<order_id>/settlement/retry`
  - 入口：`backend/app/admin_api/urls.py:38-41` → `backend/app/admin_api/views.py:1402-1456`
  - 调用支付宝：`alipay.trade.order.settle` `backend/app/secondhand_app/alipay_client.py:568-606`

## 关键实现位置
- 支付客户端：`backend/app/secondhand_app/alipay_client.py`
  - 创建交易：`create_trade` `backend/app/secondhand_app/alipay_client.py:224-314`
  - 查询交易：`query_trade` `backend/app/secondhand_app/alipay_client.py:316-373`
  - 转账：`transfer_to_account` `backend/app/secondhand_app/alipay_client.py:386-499`
  - 分账结算：`settle_order` `backend/app/secondhand_app/alipay_client.py:510-618`
  - 签名：`_sign` `backend/app/secondhand_app/alipay_client.py:114-175`
  - 验签：`_verify_sign` `backend/app/secondhand_app/alipay_client.py:176-223`
  - 通知验签封装：`verify_notify` `backend/app/secondhand_app/alipay_client.py:375-385`

- 路由注册：`backend/core/urls.py:46-51`
- 订单模型字段（支付宝交易号/分账状态等）：`backend/app/secondhand_app/models.py:123-130`

## 配置与密钥
- 沙箱网关：`https://openapi-sandbox.dl.alipaydev.com/gateway.do` `backend/core/settings.py:248`
- 应用信息：
  - `ALIPAY_APP_ID` `backend/core/settings.py:256`
  - `ALIPAY_APP_PRIVATE_KEY`（RSA2）`backend/core/settings.py:263`
  - `ALIPAY_PUBLIC_KEY` `backend/core/settings.py:271`
- 回调基础地址：
  - `FRONTEND_URL` `backend/core/settings.py:274`
  - `BACKEND_URL`（公网/隧道地址，用于 `notify_url`）`backend/core/settings.py:276`
- 上传到支付宝平台的应用公钥：`backend/app_public_key_to_upload.txt:1-9`
- 密钥使用：
  - 私钥签名：`_sign` 使用 `ALIPAY_APP_PRIVATE_KEY` `backend/app/secondhand_app/alipay_client.py:120-167`
  - 公钥验签：`_verify_sign` 使用 `ALIPAY_PUBLIC_KEY` `backend/app/secondhand_app/alipay_client.py:179-186`

## 异步通知处理
- 请求入口：`/api/payment/alipay/notify/` `backend/core/urls.py:50`
- 验签步骤：去除 `sign/sign_type` → ASCII 排序拼接 → SHA256 → RSA PKCS1 v1.5 验签 `backend/app/secondhand_app/alipay_client.py:176-223`
- 业务逻辑：`TRADE_SUCCESS/TRADE_FINISHED` 标记订单已支付并记录 `trade_no` `backend/app/secondhand_app/payment_views.py:151-171`
- 响应要求：返回纯文本 `success` `backend/app/secondhand_app/payment_views.py:180-181`

## 同步回跳与查询
- 同步回跳到前端页面，由前端轮询查询接口更新状态（示例：`frontend/src/pages/OrderDetail.vue:339-367`）
- 后端查询接口在查到成功但本地未更新时会补写状态 `backend/app/secondhand_app/payment_views.py:216-219`

## 场景流程
- 创建支付：后端生成支付表单/URL → 浏览器跳转到支付宝沙箱页面 → 支付完成后支付宝回调 `notify_url` → 后端验签更新订单 → 前端刷新状态（或同步回跳后轮询查询）
- 提现到支付宝账户：后端调用统一转账接口 → 返回成功则记录账务流水 → 失败回退余额并记录错误
- 分账：订单支付成功且满足分账条件时调用 `trade.order.settle`；可在管理后台重试

## 沙箱调试要点
- 确保 `BACKEND_URL` 为可公网访问地址（如 `ngrok`），并与支付宝开发设置中的通知地址一致
- 使用沙箱网关 `https://openapi-sandbox.dl.alipaydev.com/gateway.do`
- 公钥/私钥与开放平台配置一致：上传 `app_public_key_to_upload.txt` 的公钥；本地私钥用于签名
- 若验签失败，检查参数参与规则与编码（参考：`backend/ALIPAY_SIGNATURE_FIX_SUMMARY.md`）

